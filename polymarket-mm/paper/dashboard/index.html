<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PMM Dashboard â€” DEMO | PRODUCTION</title>
<style>
:root {
  --bg: #1a1a2e;
  --bg-card: #16213e;
  --bg-card-alt: #0f3460;
  --text: #e0e0e0;
  --text-dim: #8892b0;
  --green: #00d26a;
  --red: #ff4757;
  --yellow: #ffa502;
  --blue: #1e90ff;
  --border: #2a3a5e;
  --prod-accent: #e84393;
  --demo-accent: #f0ad4e;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
  background: var(--bg);
  color: var(--text);
  font-size: 13px;
  line-height: 1.5;
}
a { color: var(--blue); text-decoration: none; }

/* â”€â”€ Header Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  position: sticky; top: 0; z-index: 100;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  display: flex; flex-wrap: wrap; align-items: center; gap: 20px;
}
.header h1 {
  font-size: 16px; font-weight: bold;
  display: flex; align-items: center; gap: 8px;
}
.badge {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 11px; font-weight: bold;
}
.badge-running { background: var(--green); color: #000; }
.badge-stopped { background: var(--red); color: #fff; }
.badge-finished { background: var(--blue); color: #fff; }
.badge-demo { background: var(--demo-accent); color: #000; }
.badge-prod { background: var(--prod-accent); color: #fff; }
.pnl-positive { color: var(--green); font-weight: bold; }
.pnl-negative { color: var(--red); font-weight: bold; }

/* â”€â”€ Dual Panel Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.container { padding: 15px; max-width: 1800px; margin: 0 auto; }
.dual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.full-width { grid-column: 1 / -1; }
.panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
}
.panel-demo { border-left: 3px solid var(--demo-accent); }
.panel-prod { border-left: 3px solid var(--prod-accent); }
.panel-compare { border-left: 3px solid var(--blue); }
.panel-alert { border-color: var(--red) !important; box-shadow: 0 0 10px rgba(255,71,87,0.3); }
.panel-title {
  font-size: 14px; font-weight: bold;
  margin-bottom: 10px; color: var(--text);
  display: flex; align-items: center; gap: 8px;
}

/* â”€â”€ Stats Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 10px;
}
.stat-card {
  background: var(--bg);
  border-radius: 4px;
  padding: 8px 10px;
  text-align: center;
}
.stat-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }
.stat-value { font-size: 18px; font-weight: bold; margin-top: 2px; }
.stat-value.small { font-size: 14px; }

/* â”€â”€ Comparison Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.compare-table {
  width: 100%; border-collapse: collapse; font-size: 13px;
}
.compare-table th {
  text-align: left; padding: 6px 10px;
  background: var(--bg); color: var(--text-dim);
  border-bottom: 1px solid var(--border);
}
.compare-table td {
  padding: 6px 10px;
  border-bottom: 1px solid rgba(42, 58, 94, 0.5);
}
.compare-table .divergent { color: var(--red); font-weight: bold; }

/* â”€â”€ Trade Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tab-bar {
  display: flex; gap: 0; margin-bottom: 10px;
  border-bottom: 1px solid var(--border);
}
.tab {
  padding: 6px 16px; cursor: pointer;
  color: var(--text-dim); border-bottom: 2px solid transparent;
  font-size: 12px; font-weight: bold;
}
.tab.active { color: var(--text); border-bottom-color: var(--blue); }
.tab:hover { color: var(--text); }

table {
  width: 100%; border-collapse: collapse; font-size: 12px;
}
th {
  text-align: left; padding: 6px 8px;
  background: var(--bg); color: var(--text-dim);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0;
}
td {
  padding: 5px 8px;
  border-bottom: 1px solid rgba(42, 58, 94, 0.5);
}
tr:hover { background: rgba(30, 144, 255, 0.05); }
.trade-prod { background: rgba(232, 67, 147, 0.05); }

/* â”€â”€ PnL Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#pnl-chart {
  width: 100%; height: 200px; background: var(--bg);
  border-radius: 4px; border: 1px solid var(--border);
}

/* â”€â”€ Market Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.market-cards {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 12px;
}
.market-card {
  background: var(--bg-card-alt);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px;
}
.market-card-title {
  font-size: 13px; font-weight: bold; margin-bottom: 8px;
}
.market-card-row {
  display: flex; justify-content: space-between; margin-bottom: 4px;
}
.market-card-label { color: var(--text-dim); font-size: 11px; }
.market-card-value { font-weight: bold; font-size: 12px; }

.inventory-bar {
  width: 100%; height: 14px; background: var(--bg);
  border-radius: 3px; margin: 6px 0;
  position: relative; overflow: hidden;
}
.inventory-bar .center {
  position: absolute; left: 50%; top: 0; bottom: 0;
  width: 2px; background: var(--text-dim);
}
.inventory-bar .fill {
  position: absolute; top: 2px; bottom: 2px;
  border-radius: 2px;
}
.inventory-bar .fill-pos { background: var(--green); }
.inventory-bar .fill-neg { background: var(--red); }

.data-gap-dot {
  display: inline-block; width: 8px; height: 8px;
  border-radius: 50%; vertical-align: middle;
}
.gap-green { background: var(--green); }
.gap-yellow { background: var(--yellow); }
.gap-red { background: var(--red); }

/* â”€â”€ Run History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.result-pass { color: var(--green); }
.result-fail { color: var(--red); }
.result-inconclusive { color: var(--yellow); }

/* â”€â”€ Wallet Bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wallet-bar {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 6px 20px;
  display: flex; flex-wrap: wrap; align-items: center; gap: 15px;
  font-size: 11px;
}
.wallet-item { display: flex; align-items: center; gap: 4px; white-space: nowrap; }
.wallet-value { font-weight: bold; }

.exposure-bar-container {
  flex: 0; min-width: 80px; max-width: 140px;
  height: 8px; background: var(--bg);
  border-radius: 5px; overflow: hidden;
}
.exposure-bar-fill {
  height: 100%; background: linear-gradient(90deg, var(--green), var(--yellow));
  border-radius: 5px; transition: width 0.5s ease;
}
.exposure-bar-fill.high-exposure {
  background: linear-gradient(90deg, var(--yellow), var(--red));
}

.progress-bar {
  width: 100px; height: 6px; background: var(--border);
  border-radius: 4px; overflow: hidden; display: inline-block;
  vertical-align: middle;
}
.progress-fill {
  height: 100%; background: var(--blue); transition: width 0.5s ease;
}

select {
  background: var(--bg); color: var(--text);
  border: 1px solid var(--border); border-radius: 4px;
  padding: 3px 6px; font-size: 11px;
  font-family: inherit;
}

.loading { color: var(--text-dim); text-align: center; padding: 20px; }

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 900px) {
  .dual-grid { grid-template-columns: 1fr; }
  .header { padding: 8px 12px; gap: 10px; }
  .container { padding: 10px; }
}
</style>
</head>
<body>

<!-- Header Bar -->
<div class="header">
  <h1>ğŸ¦ PMM Dashboard</h1>
  <div style="display:flex;align-items:center;gap:8px">
    <span class="badge badge-demo">DEMO</span>
    <span id="demo-status" class="badge badge-stopped">â¹ OFFLINE</span>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <span class="badge badge-prod">PROD</span>
    <span id="prod-status" class="badge badge-stopped">â¹ OFFLINE</span>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    ğŸ’° Demo: <span id="demo-pnl" class="pnl-positive">$0.00</span>
    | Prod: <span id="prod-pnl" class="pnl-positive">$0.00</span>
  </div>
</div>

<div class="container">

  <!-- â”€â”€â”€ Side-by-Side Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="dual-grid">
    <!-- DEMO Panel -->
    <div class="panel panel-demo" id="demo-panel">
      <div class="panel-title">ğŸ“Š DEMO (paper)</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">PnL</div>
          <div class="stat-value" id="demo-pnl-big">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Equity</div>
          <div class="stat-value small" id="demo-equity">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Fills</div>
          <div class="stat-value small" id="demo-fills">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Fill Rate</div>
          <div class="stat-value small" id="demo-fill-rate">0%</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">PnL/hr</div>
          <div class="stat-value small" id="demo-pnl-hr">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Uptime</div>
          <div class="stat-value small" id="demo-uptime">0h 0m</div>
        </div>
      </div>
      <!-- Wallet -->
      <div class="wallet-bar" style="margin-top:10px;padding:6px 0;border:none">
        <div class="wallet-item">Avail: <span class="wallet-value" id="demo-avail">$0</span></div>
        <div class="wallet-item">Locked: <span class="wallet-value" id="demo-locked">$0</span></div>
        <div class="wallet-item">
          Exposure:
          <div class="exposure-bar-container">
            <div class="exposure-bar-fill" id="demo-exp-fill" style="width:0%"></div>
          </div>
          <span id="demo-exp-pct" style="font-size:10px">0%</span>
        </div>
      </div>
    </div>

    <!-- PRODUCTION Panel -->
    <div class="panel panel-prod" id="prod-panel">
      <div class="panel-title">ğŸ“Š PROD ($25 real)</div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">PnL</div>
          <div class="stat-value" id="prod-pnl-big">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Equity</div>
          <div class="stat-value small" id="prod-equity">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Fills</div>
          <div class="stat-value small" id="prod-fills">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Fill Rate</div>
          <div class="stat-value small" id="prod-fill-rate">0%</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">PnL/hr</div>
          <div class="stat-value small" id="prod-pnl-hr">$0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Uptime</div>
          <div class="stat-value small" id="prod-uptime">0h 0m</div>
        </div>
      </div>
      <div class="wallet-bar" style="margin-top:10px;padding:6px 0;border:none">
        <div class="wallet-item">Avail: <span class="wallet-value" id="prod-avail">$0</span></div>
        <div class="wallet-item">Locked: <span class="wallet-value" id="prod-locked">$0</span></div>
        <div class="wallet-item">
          Gas: <span class="wallet-value" id="prod-gas">$0</span>
        </div>
        <div class="wallet-item">
          Fees: <span class="wallet-value" id="prod-fees">$0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ Comparison Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel panel-compare" id="compare-panel">
    <div class="panel-title">ğŸ“ˆ Comparison Panel</div>
    <table class="compare-table">
      <thead>
        <tr>
          <th>Metric</th>
          <th>DEMO</th>
          <th>PROD</th>
          <th>Ratio</th>
        </tr>
      </thead>
      <tbody id="compare-body">
        <tr><td colspan="4" class="loading">Waiting for data from both sources...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- â”€â”€â”€ PnL Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel">
    <div class="panel-title">ğŸ“ˆ PnL Cumulativo (Demo trades)</div>
    <canvas id="pnl-chart"></canvas>
    <div style="display:flex;gap:20px;margin-top:8px;font-size:11px;color:var(--text-dim)">
      <span>Max DD: <strong id="max-dd" style="color:var(--red)">$0.00</strong></span>
      <span>Sharpe: <strong id="sharpe">0.00</strong></span>
      <span>PnL/h: <strong id="pnl-per-hour">$0.00</strong></span>
    </div>
  </div>

  <div class="dual-grid">
    <!-- â”€â”€â”€ Trade Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="panel" style="max-height:500px;overflow-y:auto">
      <div class="panel-title">ğŸ“‹ Trade Log</div>
      <div class="tab-bar">
        <div class="tab active" data-tab="demo" onclick="switchTradeTab('demo')">Demo</div>
        <div class="tab" data-tab="prod" onclick="switchTradeTab('prod')">Prod</div>
        <div class="tab" data-tab="both" onclick="switchTradeTab('both')">Both</div>
        <select id="market-filter" onchange="filterTrades()" style="margin-left:auto">
          <option value="">All Markets</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>Src</th><th>Time</th><th>Market</th><th>Side</th>
            <th>Price</th><th>Size</th><th>PnL</th><th>Lat(ms)</th>
          </tr>
        </thead>
        <tbody id="trades-body">
          <tr><td colspan="8" class="loading">Waiting for trades...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- â”€â”€â”€ Market Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="panel">
      <div class="panel-title">ğŸª Markets (Demo)</div>
      <div class="market-cards" id="market-cards">
        <div class="loading">Waiting for data...</div>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ Run History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel">
    <div class="panel-title">ğŸ“œ Run History</div>
    <table>
      <thead>
        <tr>
          <th>Run</th><th>Hypothesis</th><th>Result</th>
          <th>PnL/h</th><th>Duration</th><th>Fill Rate</th>
        </tr>
      </thead>
      <tbody id="runs-body">
        <tr><td colspan="6" class="loading">Loading...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let demoState = null;
let prodState = null;
let demoTrades = [];
let prodTrades = [];
let currentTradeTab = 'demo';
let marketFilter = '';

const BASE = '';

// â”€â”€ API Fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchJSON(url) {
  try {
    const r = await fetch(url);
    if (!r.ok) return null;
    const data = await r.json();
    return data;
  } catch { return null; }
}

async function fetchState(prod = false) {
  return fetchJSON(BASE + (prod ? '/api/state/prod' : '/api/state'));
}

async function fetchTrades(prod = false, limit = 50) {
  const base = prod ? '/api/trades/prod' : '/api/trades';
  const url = BASE + base + '?limit=' + limit + (marketFilter ? '&market=' + encodeURIComponent(marketFilter) : '');
  const data = await fetchJSON(url);
  return Array.isArray(data) ? data : [];
}

async function fetchRuns() {
  const data = await fetchJSON(BASE + '/api/runs');
  return Array.isArray(data) ? data : [];
}

// â”€â”€ Status Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStatusBadge(el, status) {
  if (!status) {
    el.className = 'badge badge-stopped';
    el.textContent = 'â¹ OFFLINE';
    return;
  }
  const s = status.toUpperCase();
  if (s === 'RUNNING') {
    el.className = 'badge badge-running';
    el.textContent = 'ğŸŸ¢ RUNNING';
  } else if (s === 'FINISHED') {
    el.className = 'badge badge-finished';
    el.textContent = 'ğŸ FINISHED';
  } else {
    el.className = 'badge badge-stopped';
    el.textContent = 'ğŸ”´ ' + s;
  }
}

// â”€â”€ Side Panel Update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSidePanel(prefix, state) {
  if (!state || !state.status) {
    document.getElementById(prefix + '-pnl-big').textContent = '$0.00';
    return;
  }
  const s = state;
  const pnl = s.pnl?.cumulative || 0;
  const pnlEl = document.getElementById(prefix + '-pnl-big');
  pnlEl.textContent = '$' + pnl.toFixed(2);
  pnlEl.className = 'stat-value' + (pnl >= 0 ? '' : '');
  pnlEl.style.color = pnl >= 0 ? 'var(--green)' : 'var(--red)';

  const headerPnl = document.getElementById(prefix + '-pnl');
  headerPnl.textContent = '$' + pnl.toFixed(2);
  headerPnl.className = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';

  const equity = s.wallet?.total_equity || s.pnl?.cumulative || 0;
  document.getElementById(prefix + '-equity').textContent = '$' + equity.toFixed(2);

  const fills = s.totals?.fills || 0;
  const fillRate = s.totals?.fill_rate_pct || 0;
  document.getElementById(prefix + '-fills').textContent = fills + ' (' + fillRate.toFixed(1) + '%)';
  document.getElementById(prefix + '-fill-rate').textContent = fillRate.toFixed(1) + '%';

  const pnlHr = s.pnl?.per_hour_avg || 0;
  const pnlHrEl = document.getElementById(prefix + '-pnl-hr');
  pnlHrEl.textContent = '$' + pnlHr.toFixed(2);
  pnlHrEl.style.color = pnlHr >= 0 ? 'var(--green)' : 'var(--red)';

  const upSec = s.uptime_seconds || 0;
  const h = Math.floor(upSec / 3600);
  const m = Math.floor((upSec % 3600) / 60);
  document.getElementById(prefix + '-uptime').textContent = h + 'h ' + m + 'm';

  // Wallet
  const w = s.wallet || {};
  document.getElementById(prefix + '-avail').textContent = '$' + (w.available_balance || 0).toFixed(2);
  document.getElementById(prefix + '-locked').textContent = '$' + (w.locked_balance || 0).toFixed(2);

  if (prefix === 'demo') {
    const expPct = w.exposure_pct || 0;
    document.getElementById('demo-exp-pct').textContent = expPct.toFixed(0) + '%';
    const expFill = document.getElementById('demo-exp-fill');
    expFill.style.width = Math.min(expPct, 100) + '%';
    expFill.className = expPct > 50 ? 'exposure-bar-fill high-exposure' : 'exposure-bar-fill';
  }

  if (prefix === 'prod') {
    const gasEl = document.getElementById('prod-gas');
    const feesEl = document.getElementById('prod-fees');
    if (gasEl) gasEl.textContent = '$' + (w.total_gas || 0).toFixed(4);
    if (feesEl) feesEl.textContent = '$' + (w.total_fees || 0).toFixed(4);
  }

  // Status
  updateStatusBadge(document.getElementById(prefix + '-status'), s.status);
}

// â”€â”€ Comparison Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateComparison(demo, prod) {
  const tbody = document.getElementById('compare-body');

  if (!demo && !prod) {
    tbody.innerHTML = '<tr><td colspan="4" class="loading">No data available</td></tr>';
    return;
  }

  function getVal(state, path) {
    if (!state) return null;
    const parts = path.split('.');
    let v = state;
    for (const p of parts) { v = v?.[p]; if (v === undefined) return null; }
    return v;
  }

  function fmt(v, suffix = '') {
    if (v === null || v === undefined) return 'â€”';
    if (typeof v === 'number') return v.toFixed(2) + suffix;
    return String(v);
  }

  const metrics = [
    { label: 'Fill Rate', dPath: 'totals.fill_rate_pct', pPath: 'totals.fill_rate_pct', suffix: '%' },
    { label: 'PnL/hr', dPath: 'pnl.per_hour_avg', pPath: 'pnl.per_hour_avg', suffix: '', prefix: '$' },
    { label: 'Max Drawdown', dPath: 'pnl.max_drawdown', pPath: 'pnl.max_drawdown', suffix: '', prefix: '$' },
    { label: 'Sharpe', dPath: 'pnl.sharpe_estimate', pPath: 'pnl.sharpe_estimate', suffix: '' },
    { label: 'Total Fills', dPath: 'totals.fills', pPath: 'totals.fills', suffix: '' },
    { label: 'Total Orders', dPath: 'totals.orders_submitted', pPath: 'totals.orders_submitted', suffix: '' },
    { label: 'WS Messages', dPath: 'totals.ws_messages', pPath: 'totals.ws_messages', suffix: '' },
    { label: 'Errors', dPath: 'totals.errors', pPath: 'totals.errors', suffix: '' },
  ];

  let html = '';
  for (const m of metrics) {
    const dv = getVal(demo, m.dPath);
    const pv = getVal(prod, m.pPath);

    let ratio = 'â€”';
    let ratioClass = '';
    if (dv !== null && pv !== null && dv !== 0 && pv !== 0) {
      const r = Math.abs(dv / pv);
      ratio = r.toFixed(2) + 'x';
      if (r > 2 || r < 0.5) ratioClass = 'divergent';
    }

    const pfx = m.prefix || '';
    html += `<tr>
      <td>${m.label}</td>
      <td>${pfx}${fmt(dv, m.suffix)}</td>
      <td>${pfx}${fmt(pv, m.suffix)}</td>
      <td class="${ratioClass}">${ratio}</td>
    </tr>`;
  }

  tbody.innerHTML = html;

  // Alert if metrics diverge >2x
  const panel = document.getElementById('compare-panel');
  const hasDivergent = panel.querySelector('.divergent');
  if (hasDivergent && demo?.status === 'RUNNING' && prod?.status === 'RUNNING') {
    panel.classList.add('panel-alert');
  } else {
    panel.classList.remove('panel-alert');
  }
}

// â”€â”€ PnL Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawPnlChart(trades) {
  const canvas = document.getElementById('pnl-chart');
  const ctx = canvas.getContext('2d');
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * (window.devicePixelRatio || 1);
  canvas.height = rect.height * (window.devicePixelRatio || 1);
  ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);

  const w = rect.width;
  const h = rect.height;
  ctx.clearRect(0, 0, w, h);

  if (!trades || trades.length < 2) {
    ctx.fillStyle = '#8892b0';
    ctx.font = '12px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('Waiting for trade data...', w / 2, h / 2);
    return;
  }

  const series = trades.map(t => parseFloat(t.pnl_cumulative || 0)).reverse();
  const minP = Math.min(0, ...series);
  const maxP = Math.max(0.01, ...series);
  const range = maxP - minP || 1;
  const pad = 20;

  let peak = series[0], maxDD = 0, ddIdx = 0;
  series.forEach((v, i) => {
    if (v > peak) peak = v;
    const dd = peak - v;
    if (dd > maxDD) { maxDD = dd; ddIdx = i; }
  });

  const xScale = (w - pad * 2) / (series.length - 1 || 1);
  const yScale = (h - pad * 2) / range;
  const toX = i => pad + i * xScale;
  const toY = v => h - pad - (v - minP) * yScale;

  // Zero line
  ctx.strokeStyle = '#2a3a5e';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad, toY(0));
  ctx.lineTo(w - pad, toY(0));
  ctx.stroke();

  // Fill area
  ctx.beginPath();
  ctx.moveTo(toX(0), toY(0));
  for (let i = 0; i < series.length; i++) ctx.lineTo(toX(i), toY(series[i]));
  ctx.lineTo(toX(series.length - 1), toY(0));
  ctx.closePath();

  const lastVal = series[series.length - 1];
  const grad = ctx.createLinearGradient(0, 0, 0, h);
  if (lastVal >= 0) {
    grad.addColorStop(0, 'rgba(0, 210, 106, 0.3)');
    grad.addColorStop(1, 'rgba(0, 210, 106, 0.02)');
  } else {
    grad.addColorStop(0, 'rgba(255, 71, 87, 0.02)');
    grad.addColorStop(1, 'rgba(255, 71, 87, 0.3)');
  }
  ctx.fillStyle = grad;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(toX(0), toY(series[0]));
  for (let i = 1; i < series.length; i++) ctx.lineTo(toX(i), toY(series[i]));
  ctx.strokeStyle = lastVal >= 0 ? '#00d26a' : '#ff4757';
  ctx.lineWidth = 2;
  ctx.stroke();

  if (maxDD > 0) {
    ctx.beginPath();
    ctx.arc(toX(ddIdx), toY(series[ddIdx]), 4, 0, Math.PI * 2);
    ctx.fillStyle = '#ff4757';
    ctx.fill();
    ctx.font = '10px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('DD -$' + maxDD.toFixed(2), toX(ddIdx), toY(series[ddIdx]) - 8);
  }
}

// â”€â”€ Trade Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTradeTab(tab) {
  currentTradeTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
  renderTrades();
}

function filterTrades() {
  marketFilter = document.getElementById('market-filter').value;
  refresh();
}

function renderTrades() {
  let trades;
  if (currentTradeTab === 'demo') trades = demoTrades;
  else if (currentTradeTab === 'prod') trades = prodTrades;
  else {
    // Merge both, sort by timestamp desc
    trades = [...demoTrades.map(t => ({...t, _src: 'D'})),
              ...prodTrades.map(t => ({...t, _src: 'P'}))];
    trades.sort((a, b) => (b.timestamp || '').localeCompare(a.timestamp || ''));
    trades = trades.slice(0, 100);
  }

  const tbody = document.getElementById('trades-body');
  if (!trades || trades.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="loading">No trades found</td></tr>';
    return;
  }

  // Update market filter
  const allTrades = [...demoTrades, ...prodTrades];
  const markets = [...new Set(allTrades.map(t => t.market_id).filter(Boolean))];
  const sel = document.getElementById('market-filter');
  const current = sel.value;
  sel.innerHTML = '<option value="">All Markets</option>' +
    markets.map(m => `<option value="${m}"${m === current ? ' selected' : ''}>${m.substring(0, 30)}</option>`).join('');

  tbody.innerHTML = trades.map(t => {
    const pnl = parseFloat(t.pnl_this_trade || 0);
    const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
    const ts = t.timestamp ? new Date(t.timestamp).toLocaleTimeString() : '?';
    const src = t._src || (t.is_production ? 'P' : 'D');
    const srcBadge = src === 'P'
      ? '<span class="badge badge-prod" style="font-size:9px;padding:1px 4px">P</span>'
      : '<span class="badge badge-demo" style="font-size:9px;padding:1px 4px">D</span>';
    const lat = t.latency_ms ? t.latency_ms.toFixed(0) : 'â€”';
    const rowClass = src === 'P' ? 'trade-prod' : '';

    return `<tr class="${rowClass}">
      <td>${srcBadge}</td>
      <td>${ts}</td>
      <td title="${t.market_id || ''}">${(t.market_id || '?').substring(0, 20)}</td>
      <td>${t.side || '?'}</td>
      <td>${t.fill_price || '?'}</td>
      <td>${t.fill_qty || '?'}</td>
      <td class="${pnlClass}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(4)}</td>
      <td>${lat}</td>
    </tr>`;
  }).join('');
}

// â”€â”€ Market Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMarkets(state) {
  const container = document.getElementById('market-cards');
  if (!state || !state.markets || Object.keys(state.markets).length === 0) {
    container.innerHTML = '<div class="loading">No active markets</div>';
    return;
  }

  container.innerHTML = Object.entries(state.markets).map(([mid, m]) => {
    const pnl = m.pnl || 0;
    const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
    const net = m.position_net || 0;
    const pct = Math.min(Math.abs(net) / 500 * 50, 50);
    const isPos = net >= 0;

    let gapClass = 'gap-green';
    const gap = m.data_gap_s || 0;
    if (gap > 10) gapClass = 'gap-red';
    else if (gap > 5) gapClass = 'gap-yellow';

    const upH = (state.uptime_seconds || 1) / 3600;
    const fph = ((m.fills_count || 0) / upH).toFixed(1);

    return `<div class="market-card">
      <div class="market-card-title">${(m.description || mid).substring(0, 45)}</div>
      <div class="market-card-row">
        <span class="market-card-label">Mid</span>
        <span class="market-card-value">${(m.mid_price || 0).toFixed(3)}</span>
      </div>
      <div class="market-card-row">
        <span class="market-card-label">Spread</span>
        <span class="market-card-value">${m.spread_bps || 0} bps</span>
      </div>
      <div class="market-card-row">
        <span class="market-card-label">PnL</span>
        <span class="market-card-value ${pnlClass}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(4)}</span>
      </div>
      <div class="market-card-row">
        <span class="market-card-label">Net Position</span>
        <span class="market-card-value">${net.toFixed(0)}</span>
      </div>
      <div class="inventory-bar">
        <div class="center"></div>
        ${isPos ?
          `<div class="fill fill-pos" style="left:50%;width:${pct}%"></div>` :
          `<div class="fill fill-neg" style="right:50%;width:${pct}%"></div>`}
      </div>
      <div class="market-card-row">
        <span class="market-card-label">Fills/h</span>
        <span class="market-card-value">${fph}</span>
      </div>
      <div class="market-card-row">
        <span class="market-card-label">Data Gap</span>
        <span><span class="data-gap-dot ${gapClass}"></span> ${gap.toFixed(1)}s</span>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ Run History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRuns(runs) {
  const tbody = document.getElementById('runs-body');
  if (!runs || runs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="loading">No runs recorded</td></tr>';
    return;
  }

  tbody.innerHTML = runs.map(r => {
    let resultClass = 'result-inconclusive';
    let resultBadge = 'âš ï¸ INCONCLUSIVE';
    if (r.result === 'PASS') { resultClass = 'result-pass'; resultBadge = 'âœ… PASS'; }
    else if (r.result === 'FAIL') { resultClass = 'result-fail'; resultBadge = 'âŒ FAIL'; }

    return `<tr>
      <td>${r.run_id || '?'}</td>
      <td>${r.hypothesis || '?'}</td>
      <td class="${resultClass}">${resultBadge}</td>
      <td>$${(r.pnl_per_hour || 0).toFixed(2)}</td>
      <td>${(r.duration_h || 0).toFixed(1)}h</td>
      <td>${(r.fill_rate || 0).toFixed(1)}%</td>
    </tr>`;
  }).join('');
}

// â”€â”€ PnL stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePnlStats(state) {
  if (!state || !state.pnl) return;
  document.getElementById('max-dd').textContent = '$' + (state.pnl.max_drawdown || 0).toFixed(2);
  document.getElementById('sharpe').textContent = (state.pnl.sharpe_estimate || 0).toFixed(2);
  document.getElementById('pnl-per-hour').textContent = '$' + (state.pnl.per_hour_avg || 0).toFixed(2);
}

// â”€â”€ Main Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refresh() {
  const [demo, prod, demT, prdT, runs] = await Promise.all([
    fetchState(false),
    fetchState(true),
    fetchTrades(false, 50),
    fetchTrades(true, 50),
    fetchRuns(),
  ]);

  demoState = demo;
  prodState = prod;
  demoTrades = demT || [];
  prodTrades = prdT || [];

  updateSidePanel('demo', demo);
  updateSidePanel('prod', prod);
  updateComparison(demo, prod);
  renderTrades();
  renderMarkets(demo);
  renderRuns(runs);
  drawPnlChart(demoTrades);
  updatePnlStats(demo);
}

// Initial load + auto-refresh every 5s
refresh();
setInterval(refresh, 5000);

// Resize handler for chart
window.addEventListener('resize', () => drawPnlChart(demoTrades));
</script>
</body>
</html>
