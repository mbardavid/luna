<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PMM Paper Trading Dashboard</title>
<style>
:root {
  --bg: #1a1a2e;
  --bg-card: #16213e;
  --bg-card-alt: #0f3460;
  --text: #e0e0e0;
  --text-dim: #8892b0;
  --green: #00d26a;
  --red: #ff4757;
  --yellow: #ffa502;
  --blue: #1e90ff;
  --border: #2a3a5e;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
  background: var(--bg);
  color: var(--text);
  font-size: 13px;
  line-height: 1.5;
}
a { color: var(--blue); text-decoration: none; }

/* â”€â”€ Header Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  position: sticky; top: 0; z-index: 100;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  display: flex; flex-wrap: wrap; align-items: center; gap: 20px;
}
.header-item {
  display: flex; align-items: center; gap: 6px;
  white-space: nowrap;
}
.badge {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 11px; font-weight: bold;
}
.badge-running { background: var(--green); color: #000; }
.badge-stopped { background: var(--red); color: #fff; }
.badge-error { background: var(--red); color: #fff; }
.badge-finished { background: var(--blue); color: #fff; }
.badge-demo {
  background: #f0ad4e; color: #000; font-weight: bold;
  padding: 2px 10px; border-radius: 4px; font-size: 11px;
  letter-spacing: 1px;
}
.pnl-positive { color: var(--green); font-weight: bold; }
.pnl-negative { color: var(--red); font-weight: bold; }

.progress-bar {
  width: 120px; height: 8px; background: var(--border);
  border-radius: 4px; overflow: hidden; display: inline-block;
  vertical-align: middle;
}
.progress-fill {
  height: 100%; background: var(--blue); transition: width 0.5s ease;
}

/* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.container { padding: 15px; max-width: 1600px; margin: 0 auto; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
.panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
}
.panel-title {
  font-size: 14px; font-weight: bold;
  margin-bottom: 10px; color: var(--text);
  display: flex; align-items: center; gap: 8px;
  cursor: pointer; user-select: none;
}
.panel-title .toggle { font-size: 12px; color: var(--text-dim); }

/* â”€â”€ PnL Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#pnl-chart {
  width: 100%; height: 200px; background: var(--bg);
  border-radius: 4px; border: 1px solid var(--border);
}

/* â”€â”€ Tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
table {
  width: 100%; border-collapse: collapse;
  font-size: 12px;
}
th {
  text-align: left; padding: 6px 8px;
  background: var(--bg); color: var(--text-dim);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0;
}
td {
  padding: 5px 8px;
  border-bottom: 1px solid rgba(42, 58, 94, 0.5);
}
tr:hover { background: rgba(30, 144, 255, 0.05); }

/* â”€â”€ Market Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.market-cards {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 12px;
}
.market-card {
  background: var(--bg-card-alt);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 12px;
}
.market-card-title {
  font-size: 13px; font-weight: bold;
  margin-bottom: 8px; color: var(--text);
}
.market-card-row {
  display: flex; justify-content: space-between;
  margin-bottom: 4px;
}
.market-card-label { color: var(--text-dim); font-size: 11px; }
.market-card-value { font-weight: bold; font-size: 12px; }

.inventory-bar {
  width: 100%; height: 14px; background: var(--bg);
  border-radius: 3px; margin: 6px 0;
  position: relative; overflow: hidden;
}
.inventory-bar .center {
  position: absolute; left: 50%; top: 0; bottom: 0;
  width: 2px; background: var(--text-dim);
}
.inventory-bar .fill {
  position: absolute; top: 2px; bottom: 2px;
  border-radius: 2px;
}
.inventory-bar .fill-pos { background: var(--green); }
.inventory-bar .fill-neg { background: var(--red); }

.data-gap-dot {
  display: inline-block; width: 8px; height: 8px;
  border-radius: 50%; vertical-align: middle;
}
.gap-green { background: var(--green); }
.gap-yellow { background: var(--yellow); }
.gap-red { background: var(--red); }

/* â”€â”€ Strategy Internals (collapsible) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.strategy-section { display: none; margin-top: 10px; }
.strategy-section.open { display: block; }
.gauge-row { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 8px; }
.gauge {
  flex: 1; min-width: 80px;
  background: var(--bg); border-radius: 4px; padding: 6px 8px;
  text-align: center;
}
.gauge-label { font-size: 10px; color: var(--text-dim); }
.gauge-value { font-size: 14px; font-weight: bold; }

/* â”€â”€ Rationale Expand â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rationale-trigger {
  cursor: pointer; color: var(--blue);
  max-width: 200px; overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap;
}
.rationale-detail {
  display: none; padding: 8px;
  background: var(--bg); border-radius: 4px;
  font-size: 11px; margin-top: 4px;
}
.rationale-detail.open { display: block; }

/* â”€â”€ Run History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.result-pass { color: var(--green); }
.result-fail { color: var(--red); }
.result-inconclusive { color: var(--yellow); }

/* â”€â”€ Filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
select {
  background: var(--bg); color: var(--text);
  border: 1px solid var(--border); border-radius: 4px;
  padding: 4px 8px; font-size: 12px;
  font-family: inherit;
}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {
  .header { padding: 8px 12px; gap: 10px; }
  .grid-2 { grid-template-columns: 1fr; }
  .market-cards { grid-template-columns: 1fr; }
  .container { padding: 10px; }
}

/* â”€â”€ Wallet Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wallet-bar {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 8px 20px;
  display: flex; flex-wrap: wrap; align-items: center; gap: 20px;
  font-size: 12px;
}
.wallet-item { display: flex; align-items: center; gap: 4px; white-space: nowrap; }
.wallet-value { font-weight: bold; }
.exposure-bar-container {
  flex: 1; min-width: 100px; max-width: 200px;
  height: 10px; background: var(--bg);
  border-radius: 5px; overflow: hidden;
}
.exposure-bar-fill {
  height: 100%; background: linear-gradient(90deg, var(--green), var(--yellow));
  border-radius: 5px; transition: width 0.5s ease;
}
.exposure-bar-fill.high-exposure {
  background: linear-gradient(90deg, var(--yellow), var(--red));
}
.allocation-pct { font-size: 10px; color: var(--text-dim); }
.high-allocation { color: var(--yellow) !important; font-weight: bold; }

.loading { color: var(--text-dim); text-align: center; padding: 30px; }
</style>
</head>
<body>

<!-- Header Bar -->
<div class="header" id="header">
  <div class="header-item">
    <span class="badge badge-demo">DEMO</span>
    <span id="status-badge" class="badge badge-stopped">â¹ OFFLINE</span>
  </div>
  <div class="header-item">
    ğŸ’° <span id="pnl-total" class="pnl-positive">$0.00</span>
  </div>
  <div class="header-item">
    â±ï¸ <span id="uptime">0h 0m</span>
    <div class="progress-bar"><div class="progress-fill" id="progress" style="width:0%"></div></div>
    <span id="progress-pct">0%</span>
  </div>
  <div class="header-item">
    ğŸ“Š Fill: <span id="fill-rate">0%</span>
  </div>
  <div class="header-item">
    ğŸ›¡ï¸ <span id="kill-switch">N/A</span>
  </div>
  <div class="header-item">
    ğŸ§ª <span id="hypothesis">â€”</span>
  </div>
</div>

<!-- Wallet Bar -->
<div class="wallet-bar" id="wallet-bar">
  <div class="wallet-item">
    ğŸ’° Available: <span class="wallet-value" id="wallet-available">$0.00</span>
  </div>
  <div class="wallet-item">
    ğŸ”’ Locked: <span class="wallet-value" id="wallet-locked">$0.00</span>
  </div>
  <div class="wallet-item">
    ğŸ“Š Equity: <span class="wallet-value" id="wallet-equity">$0.00</span>
    <span id="wallet-pnl-pct" style="font-size:11px"></span>
  </div>
  <div class="wallet-item">
    Exposure:
    <div class="exposure-bar-container">
      <div class="exposure-bar-fill" id="exposure-fill" style="width:0%"></div>
    </div>
    <span id="exposure-pct" style="font-size:11px">0%</span>
  </div>
</div>

<div class="container">

  <!-- PnL Chart -->
  <div class="panel">
    <div class="panel-title">ğŸ“ˆ PnL Cumulativo</div>
    <canvas id="pnl-chart"></canvas>
    <div style="display:flex;gap:20px;margin-top:8px;font-size:11px;color:var(--text-dim)">
      <span>Max DD: <strong id="max-dd" style="color:var(--red)">$0.00</strong></span>
      <span>Sharpe: <strong id="sharpe">0.00</strong></span>
      <span>PnL/h: <strong id="pnl-per-hour">$0.00</strong></span>
    </div>
  </div>

  <div class="grid-2">
    <!-- Trade Log -->
    <div class="panel" style="max-height:500px;overflow-y:auto">
      <div class="panel-title">
        ğŸ“‹ Trade Log
        <select id="market-filter" onchange="filterTrades()">
          <option value="">All Markets</option>
        </select>
      </div>
      <table>
        <thead>
          <tr>
            <th>Time</th><th>Market</th><th>Side</th><th>Token</th>
            <th>Price</th><th>Size</th><th>PnL</th><th>Rationale</th>
          </tr>
        </thead>
        <tbody id="trades-body">
          <tr><td colspan="8" class="loading">Aguardando trades...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Market Cards -->
    <div class="panel">
      <div class="panel-title">ğŸª Markets</div>
      <div class="market-cards" id="market-cards">
        <div class="loading">Aguardando dados...</div>
      </div>
    </div>
  </div>

  <!-- Run History -->
  <div class="panel">
    <div class="panel-title">ğŸ“œ Run History</div>
    <table>
      <thead>
        <tr>
          <th>Run</th><th>Hypothesis</th><th>Result</th>
          <th>PnL/h</th><th>Duration</th><th>Fill Rate</th>
        </tr>
      </thead>
      <tbody id="runs-body">
        <tr><td colspan="6" class="loading">Aguardando histÃ³rico...</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentState = null;
let allTrades = [];
let pnlHistory = [];
let marketFilter = '';

// â”€â”€ API Fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BASE = '';  // Same origin

async function fetchState() {
  try {
    const r = await fetch(BASE + '/api/state');
    if (!r.ok) return null;
    return await r.json();
  } catch { return null; }
}

async function fetchTrades(limit = 50) {
  try {
    const url = BASE + '/api/trades?limit=' + limit + (marketFilter ? '&market=' + encodeURIComponent(marketFilter) : '');
    const r = await fetch(url);
    if (!r.ok) return [];
    return await r.json();
  } catch { return []; }
}

async function fetchRuns() {
  try {
    const r = await fetch(BASE + '/api/runs');
    if (!r.ok) return [];
    const data = await r.json();
    return Array.isArray(data) ? data : [];
  } catch { return []; }
}

// â”€â”€ Header Update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHeader(s) {
  if (!s || !s.status) {
    document.getElementById('status-badge').className = 'badge badge-stopped';
    document.getElementById('status-badge').textContent = 'â¹ OFFLINE';
    return;
  }

  const badge = document.getElementById('status-badge');
  const status = s.status.toUpperCase();
  if (status === 'RUNNING') {
    badge.className = 'badge badge-running';
    badge.textContent = 'ğŸŸ¢ RUNNING';
  } else if (status === 'FINISHED') {
    badge.className = 'badge badge-finished';
    badge.textContent = 'ğŸ FINISHED';
  } else {
    badge.className = 'badge badge-error';
    badge.textContent = 'ğŸ”´ ' + status;
  }

  // PnL
  const pnl = s.pnl?.cumulative || 0;
  const pnlEl = document.getElementById('pnl-total');
  pnlEl.textContent = '$' + pnl.toFixed(2);
  pnlEl.className = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';

  // Uptime
  const upSec = s.uptime_seconds || 0;
  const h = Math.floor(upSec / 3600);
  const m = Math.floor((upSec % 3600) / 60);
  document.getElementById('uptime').textContent = h + 'h ' + m + 'm';

  // Progress
  const pct = s.progress_pct || 0;
  document.getElementById('progress').style.width = pct + '%';
  document.getElementById('progress-pct').textContent = pct.toFixed(1) + '%';

  // Fill Rate
  document.getElementById('fill-rate').textContent =
    (s.totals?.fill_rate_pct || 0).toFixed(1) + '%';

  // Kill Switch â€” check per-market
  const ksStates = new Set();
  if (s.markets) {
    Object.values(s.markets).forEach(m => {
      if (m.kill_switch) ksStates.add(m.kill_switch);
    });
  }
  document.getElementById('kill-switch').textContent =
    ksStates.size > 0 ? [...ksStates].join(', ') : 'N/A';

  // Hypothesis
  document.getElementById('hypothesis').textContent =
    s.hypothesis_under_test || 'â€”';

  // PnL stats
  document.getElementById('max-dd').textContent =
    '$' + (s.pnl?.max_drawdown || 0).toFixed(2);
  document.getElementById('sharpe').textContent =
    (s.pnl?.sharpe_estimate || 0).toFixed(2);
  document.getElementById('pnl-per-hour').textContent =
    '$' + (s.pnl?.per_hour_avg || 0).toFixed(2);

  // â”€â”€ Wallet Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  updateWallet(s.wallet);
}

function updateWallet(w) {
  if (!w) return;
  document.getElementById('wallet-available').textContent = '$' + (w.available_balance || 0).toFixed(2);
  document.getElementById('wallet-locked').textContent = '$' + (w.locked_balance || 0).toFixed(2);

  const equity = w.total_equity || 0;
  document.getElementById('wallet-equity').textContent = '$' + equity.toFixed(2);

  const pnlPct = w.pnl_pct || 0;
  const pnlPctEl = document.getElementById('wallet-pnl-pct');
  pnlPctEl.textContent = '(' + (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(2) + '%)';
  pnlPctEl.style.color = pnlPct >= 0 ? 'var(--green)' : 'var(--red)';

  const exposurePct = w.exposure_pct || 0;
  document.getElementById('exposure-pct').textContent = exposurePct.toFixed(1) + '%';
  const exposureFill = document.getElementById('exposure-fill');
  exposureFill.style.width = Math.min(exposurePct, 100) + '%';
  exposureFill.className = exposurePct > 50 ? 'exposure-bar-fill high-exposure' : 'exposure-bar-fill';
}

// â”€â”€ PnL Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawPnlChart(trades) {
  const canvas = document.getElementById('pnl-chart');
  const ctx = canvas.getContext('2d');
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * (window.devicePixelRatio || 1);
  canvas.height = rect.height * (window.devicePixelRatio || 1);
  ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);

  const w = rect.width;
  const h = rect.height;
  ctx.clearRect(0, 0, w, h);

  if (!trades || trades.length < 2) {
    ctx.fillStyle = '#8892b0';
    ctx.font = '12px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('Aguardando dados para plotar...', w / 2, h / 2);
    return;
  }

  // Build PnL series from cumulative values
  const series = trades.map(t => parseFloat(t.pnl_cumulative || 0)).reverse();
  const minP = Math.min(0, ...series);
  const maxP = Math.max(0.01, ...series);
  const range = maxP - minP || 1;
  const pad = 20;

  // Find max drawdown point
  let peak = series[0], maxDD = 0, ddIdx = 0;
  series.forEach((v, i) => {
    if (v > peak) peak = v;
    const dd = peak - v;
    if (dd > maxDD) { maxDD = dd; ddIdx = i; }
  });

  const xScale = (w - pad * 2) / (series.length - 1 || 1);
  const yScale = (h - pad * 2) / range;
  const toX = i => pad + i * xScale;
  const toY = v => h - pad - (v - minP) * yScale;

  // Zero line
  const y0 = toY(0);
  ctx.strokeStyle = '#2a3a5e';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad, y0);
  ctx.lineTo(w - pad, y0);
  ctx.stroke();

  // Fill area
  ctx.beginPath();
  ctx.moveTo(toX(0), y0);
  for (let i = 0; i < series.length; i++) {
    ctx.lineTo(toX(i), toY(series[i]));
  }
  ctx.lineTo(toX(series.length - 1), y0);
  ctx.closePath();

  // Gradient
  const lastVal = series[series.length - 1];
  if (lastVal >= 0) {
    const grad = ctx.createLinearGradient(0, 0, 0, h);
    grad.addColorStop(0, 'rgba(0, 210, 106, 0.3)');
    grad.addColorStop(1, 'rgba(0, 210, 106, 0.02)');
    ctx.fillStyle = grad;
  } else {
    const grad = ctx.createLinearGradient(0, 0, 0, h);
    grad.addColorStop(0, 'rgba(255, 71, 87, 0.02)');
    grad.addColorStop(1, 'rgba(255, 71, 87, 0.3)');
    ctx.fillStyle = grad;
  }
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(toX(0), toY(series[0]));
  for (let i = 1; i < series.length; i++) {
    ctx.lineTo(toX(i), toY(series[i]));
  }
  ctx.strokeStyle = lastVal >= 0 ? '#00d26a' : '#ff4757';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Max drawdown marker
  if (maxDD > 0) {
    ctx.beginPath();
    ctx.arc(toX(ddIdx), toY(series[ddIdx]), 4, 0, Math.PI * 2);
    ctx.fillStyle = '#ff4757';
    ctx.fill();
    ctx.fillStyle = '#ff4757';
    ctx.font = '10px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('DD -$' + maxDD.toFixed(2), toX(ddIdx), toY(series[ddIdx]) - 8);
  }
}

// â”€â”€ Trade Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTrades(trades) {
  const tbody = document.getElementById('trades-body');
  if (!trades || trades.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="loading">Nenhuma trade encontrada</td></tr>';
    return;
  }

  // Update market filter dropdown
  const markets = [...new Set(trades.map(t => t.market_id).filter(Boolean))];
  const sel = document.getElementById('market-filter');
  const current = sel.value;
  const opts = '<option value="">All Markets</option>' +
    markets.map(m => `<option value="${m}"${m === current ? ' selected' : ''}>${m.substring(0, 35)}</option>`).join('');
  sel.innerHTML = opts;

  tbody.innerHTML = trades.map((t, i) => {
    const pnl = parseFloat(t.pnl_this_trade || 0);
    const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
    const ts = t.timestamp ? new Date(t.timestamp).toLocaleTimeString() : '?';
    const rationale = t.entry_rationale || {};
    const trigger = (rationale.trigger || 'N/A').substring(0, 50);
    const detailId = 'rat-' + i;

    let detail = '';
    if (rationale.spread_model) {
      detail += '<div><b>Spread Model:</b> ' + JSON.stringify(rationale.spread_model) + '</div>';
    }
    if (rationale.inventory_skew) {
      detail += '<div><b>Inventory Skew:</b> ' + JSON.stringify(rationale.inventory_skew) + '</div>';
    }
    if (rationale.toxic_flow) {
      detail += '<div><b>Toxic Flow:</b> ' + JSON.stringify(rationale.toxic_flow) + '</div>';
    }

    return `<tr>
      <td>${ts}</td>
      <td title="${t.market_id || ''}">${(t.market_id || '?').substring(0, 25)}</td>
      <td>${t.side || '?'}</td>
      <td>${t.token || '?'}</td>
      <td>${t.fill_price || '?'}</td>
      <td>${t.fill_qty || '?'}</td>
      <td class="${pnlClass}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(4)}</td>
      <td>
        <div class="rationale-trigger" onclick="toggleRationale('${detailId}')">${trigger}</div>
        <div id="${detailId}" class="rationale-detail">${detail || 'No details'}</div>
      </td>
    </tr>`;
  }).join('');
}

function toggleRationale(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('open');
}

function filterTrades() {
  marketFilter = document.getElementById('market-filter').value;
  refresh();
}

// â”€â”€ Market Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMarkets(state) {
  const container = document.getElementById('market-cards');
  if (!state || !state.markets || Object.keys(state.markets).length === 0) {
    container.innerHTML = '<div class="loading">Nenhum mercado ativo</div>';
    return;
  }

  const totalEquity = state.wallet?.total_equity || 500;

  container.innerHTML = Object.entries(state.markets).map(([mid, m]) => {
    const pnl = m.pnl || 0;
    const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
    const net = m.position_net || 0;
    const maxPos = 500;
    const pct = Math.min(Math.abs(net) / maxPos * 50, 50);
    const isPos = net >= 0;

    // Data gap indicator
    let gapClass = 'gap-green';
    const gap = m.data_gap_s || 0;
    if (gap > 10) gapClass = 'gap-red';
    else if (gap > 5) gapClass = 'gap-yellow';

    // Fills per hour
    const upH = (state.uptime_seconds || 1) / 3600;
    const fph = ((m.fills_count || 0) / upH).toFixed(1);

    // Allocation percentage: position_value / total_equity
    const midPrice = m.mid_price || 0;
    const positionValue = Math.abs(net) * midPrice;
    const allocationPct = totalEquity > 0 ? (positionValue / totalEquity * 100) : 0;
    const maxAllocation = 30; // 30% max allocation per market
    const allocationClass = allocationPct > maxAllocation ? 'high-allocation' : 'allocation-pct';

    return `<div class="market-card" ${allocationPct > maxAllocation ? 'style="border-color: var(--yellow)"' : ''}>
      <div class="market-card-title">${(m.description || mid).substring(0, 45)}</div>
      <div class="market-card-row">
        <span class="market-card-label">Mid</span>
        <span class="market-card-value">${(m.mid_price || 0).toFixed(3)}</span>
      </div>
      <div class="market-card-row">
        <span class="market-card-label">Spread</span>
        <span class="market-card-value">${m.spread_bps || 0} bps</span>
      </div>
      <div class="market-card-row">
        <span class="market-card-label">PnL</span>
        <span class="market-card-value ${pnlClass}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(4)}</span>
      </div>
      <div class="market-card-row">
        <span class="market-card-label">Net Position</span>
        <span class="market-card-value">${net.toFixed(0)}</span>
      </div>
      <div class="market-card-row">
        <span class="market-card-label">Allocation</span>
        <span class="market-card-value ${allocationClass}">${allocationPct.toFixed(1)}%</span>
      </div>
      <div class="inventory-bar">
        <div class="center"></div>
        ${isPos ?
          `<div class="fill fill-pos" style="left:50%;width:${pct}%"></div>` :
          `<div class="fill fill-neg" style="right:50%;width:${pct}%"></div>`
        }
      </div>
      <div class="market-card-row">
        <span class="market-card-label">Fills/h</span>
        <span class="market-card-value">${fph}</span>
      </div>
      <div class="market-card-row">
        <span class="market-card-label">Data Gap</span>
        <span><span class="data-gap-dot ${gapClass}"></span> ${gap.toFixed(1)}s</span>
      </div>
      <div class="panel-title" onclick="toggleStrategy('strat-${mid}')" style="margin-top:8px;font-size:11px">
        âš™ï¸ Strategy Internals <span class="toggle">â–¶</span>
      </div>
      <div id="strat-${mid}" class="strategy-section">
        <div class="gauge-row">
          <div class="gauge">
            <div class="gauge-label">Kills</div>
            <div class="gauge-value">${m.kill_switch || 'N/A'}</div>
          </div>
          <div class="gauge">
            <div class="gauge-label">Fills</div>
            <div class="gauge-value">${m.fills_count || 0}</div>
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

function toggleStrategy(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('open');
}

// â”€â”€ Run History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRuns(runs) {
  const tbody = document.getElementById('runs-body');
  if (!runs || runs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" class="loading">Nenhum run registrado</td></tr>';
    return;
  }

  tbody.innerHTML = runs.map(r => {
    let resultClass = 'result-inconclusive';
    let resultBadge = 'âš ï¸ INCONCLUSIVE';
    if (r.result === 'PASS') { resultClass = 'result-pass'; resultBadge = 'âœ… PASS'; }
    else if (r.result === 'FAIL') { resultClass = 'result-fail'; resultBadge = 'âŒ FAIL'; }

    return `<tr>
      <td>${r.run_id || '?'}</td>
      <td>${r.hypothesis || '?'}</td>
      <td class="${resultClass}">${resultBadge}</td>
      <td>$${(r.pnl_per_hour || 0).toFixed(2)}</td>
      <td>${(r.duration_h || 0).toFixed(1)}h</td>
      <td>${(r.fill_rate || 0).toFixed(1)}%</td>
    </tr>`;
  }).join('');
}

// â”€â”€ Main Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refresh() {
  const [state, trades, runs] = await Promise.all([
    fetchState(),
    fetchTrades(50),
    fetchRuns(),
  ]);

  currentState = state;
  allTrades = trades;

  updateHeader(state);
  renderTrades(trades);
  renderMarkets(state);
  renderRuns(runs);
  drawPnlChart(trades);
}

// Initial load + auto-refresh every 5s
refresh();
setInterval(refresh, 5000);

// Resize handler for chart
window.addEventListener('resize', () => drawPnlChart(allTrades));
</script>
</body>
</html>
