{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://openclaw.local/blockchain-operator/execution-plane.schema.v1.json",
  "title": "Crypto Sage Execution Plane Envelope v1",
  "type": "object",
  "required": ["schemaVersion", "plane", "operation", "requestId", "correlationId", "intent"],
  "properties": {
    "schemaVersion": { "const": "v1" },
    "plane": { "const": "execution" },
    "operation": {
      "type": "string",
      "enum": [
        "bridge",
        "swap.jupiter",
        "swap.raydium",
        "swap.pumpfun",
        "defi.deposit",
        "defi.withdraw",
        "hyperliquid.spot.order",
        "hyperliquid.perp.order",
        "transfer",
        "send",
        "hyperliquid.cancel",
        "hyperliquid.modify"
      ]
    },
    "requestId": { "type": "string", "pattern": "^[A-Za-z0-9._:-]{6,128}$" },
    "correlationId": { "type": "string", "pattern": "^[A-Za-z0-9._:-]{6,128}$" },
    "idempotencyKey": { "type": "string", "minLength": 8, "maxLength": 256 },
    "timestamp": { "type": "string", "format": "date-time" },
    "dryRun": { "type": "boolean" },
    "meta": {
      "type": "object",
      "properties": {
        "mentionDelegationMode": { "type": "string", "enum": ["disabled", "gated"] },
        "mentionDelegation": {
          "type": "object",
          "required": [
            "channel",
            "messageId",
            "originBotId",
            "targetBotId",
            "observedAt",
            "ttlSeconds",
            "dedupeBy",
            "delegatedHumanProxy"
          ],
          "properties": {
            "channel": { "type": "string", "pattern": "^discord:(channel|thread):[0-9]{6,30}$" },
            "messageId": { "type": "string", "pattern": "^[0-9]{6,30}$" },
            "originBotId": { "type": "string", "pattern": "^[A-Za-z0-9._:-]{2,128}$" },
            "targetBotId": { "type": "string", "pattern": "^[A-Za-z0-9._:-]{2,128}$" },
            "observedAt": { "type": "string", "format": "date-time" },
            "ttlSeconds": { "type": "integer", "minimum": 5, "maximum": 3600 },
            "dedupeBy": { "const": "messageId" },
            "delegatedHumanProxy": {
              "type": "object",
              "required": ["mode", "policyValidated", "envelopeValidated", "riskGatePassed"],
              "properties": {
                "mode": { "const": "delegated-human-proxy" },
                "policyValidated": { "const": true },
                "envelopeValidated": { "const": true },
                "riskGatePassed": { "const": true },
                "riskClassification": {
                  "type": "string",
                  "enum": ["read", "diagnostic", "sensitive", "live"]
                },
                "authorizationRef": { "type": ["string", "null"], "minLength": 3, "maxLength": 180 }
              },
              "additionalProperties": true
            }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "auth": {
      "type": "object",
      "required": ["scheme", "keyId", "nonce", "timestamp", "signature"],
      "properties": {
        "scheme": { "const": "hmac-sha256-v1" },
        "keyId": { "type": "string", "pattern": "^[A-Za-z0-9._:-]{6,128}$" },
        "nonce": { "type": "string", "pattern": "^[A-Za-z0-9._:-]{8,128}$" },
        "timestamp": { "type": "string", "format": "date-time" },
        "signature": { "type": "string", "minLength": 16, "maxLength": 512 }
      },
      "additionalProperties": false
    },
    "intent": { "type": "object" }
  },
  "additionalProperties": false,
  "allOf": [
    {
      "if": {
        "properties": {
          "meta": {
            "type": "object",
            "properties": {
              "mentionDelegationMode": { "const": "gated" }
            },
            "required": ["mentionDelegationMode"]
          }
        },
        "required": ["meta"]
      },
      "then": {
        "properties": {
          "meta": {
            "required": ["mentionDelegation"]
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "meta": {
            "type": "object",
            "required": ["mentionDelegation"]
          }
        },
        "required": ["meta"]
      },
      "then": {
        "properties": {
          "meta": {
            "required": ["mentionDelegationMode"],
            "properties": {
              "mentionDelegationMode": { "const": "gated" }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "operation": { "const": "bridge" } }, "required": ["operation"] },
      "then": {
        "properties": {
          "intent": {
            "type": "object",
            "required": ["fromChain", "toChain", "asset", "amount"],
            "properties": {
              "fromChain": { "enum": ["base", "solana"] },
              "toChain": { "enum": ["base", "solana"] },
              "asset": { "type": "string", "minLength": 2, "maxLength": 32 },
              "amount": { "$ref": "#/$defs/numericOrString" },
              "recipient": { "type": "string", "minLength": 32, "maxLength": 64 },
              "provider": { "const": "debridge" },
              "quoteId": { "type": "string", "minLength": 1, "maxLength": 128 },
              "maxSlippageBps": { "type": "integer", "minimum": 0, "maximum": 10000 }
            },
            "additionalProperties": false
          }
        }
      }
    },
    {
      "if": { "properties": { "operation": { "const": "swap.jupiter" } }, "required": ["operation"] },
      "then": {
        "properties": {
          "intent": {
            "type": "object",
            "required": ["chain", "inAsset", "outAsset", "amount"],
            "properties": {
              "chain": { "const": "solana" },
              "inAsset": { "type": "string", "minLength": 2, "maxLength": 32 },
              "outAsset": { "type": "string", "minLength": 2, "maxLength": 32 },
              "amount": { "$ref": "#/$defs/numericOrString" },
              "mode": { "enum": ["ExactIn", "ExactOut"] },
              "slippageBps": { "type": "integer", "minimum": 0, "maximum": 10000 },
              "recipient": { "type": "string", "minLength": 32, "maxLength": 64 },
              "routeHint": { "type": "string", "minLength": 1, "maxLength": 128 }
            },
            "additionalProperties": false
          }
        }
      }
    },
    {
      "if": { "properties": { "operation": { "const": "swap.raydium" } }, "required": ["operation"] },
      "then": {
        "properties": {
          "intent": {
            "type": "object",
            "required": ["chain", "inAsset", "outAsset", "amount"],
            "properties": {
              "chain": { "const": "solana" },
              "inAsset": { "type": "string", "minLength": 2, "maxLength": 32 },
              "outAsset": { "type": "string", "minLength": 2, "maxLength": 32 },
              "amount": { "$ref": "#/$defs/numericOrString" },
              "slippageBps": { "type": "integer", "minimum": 0, "maximum": 10000 },
              "poolId": { "type": "string", "minLength": 1, "maxLength": 160 },
              "recipient": { "type": "string", "minLength": 32, "maxLength": 64 }
            },
            "additionalProperties": false
          }
        }
      }
    },
    {
      "if": { "properties": { "operation": { "const": "swap.pumpfun" } }, "required": ["operation"] },
      "then": {
        "properties": {
          "intent": {
            "type": "object",
            "required": ["chain", "side", "symbol", "amount"],
            "properties": {
              "chain": { "const": "solana" },
              "side": { "enum": ["buy", "sell"] },
              "symbol": { "type": "string", "minLength": 1, "maxLength": 24 },
              "mint": { "type": "string", "minLength": 32, "maxLength": 64 },
              "amount": { "$ref": "#/$defs/numericOrString" },
              "amountType": { "enum": ["base", "quote"] },
              "slippageBps": { "type": "integer", "minimum": 0, "maximum": 10000 },
              "recipient": { "type": "string", "minLength": 32, "maxLength": 64 }
            },
            "additionalProperties": false
          }
        }
      }
    },
    {
      "if": { "properties": { "operation": { "const": "defi.deposit" } }, "required": ["operation"] },
      "then": {
        "properties": {
          "intent": {
            "type": "object",
            "required": ["chain", "protocol", "target", "asset", "amount"],
            "properties": {
              "chain": { "enum": ["base", "solana"] },
              "protocol": { "type": "string", "minLength": 2, "maxLength": 64 },
              "target": { "type": "string", "minLength": 2, "maxLength": 128 },
              "asset": { "type": "string", "minLength": 2, "maxLength": 32 },
              "amount": { "$ref": "#/$defs/numericOrString" },
              "minSharesOut": { "$ref": "#/$defs/numericOrString" },
              "recipient": { "type": "string", "minLength": 32, "maxLength": 64 }
            },
            "additionalProperties": false
          }
        }
      }
    },
    {
      "if": { "properties": { "operation": { "const": "defi.withdraw" } }, "required": ["operation"] },
      "then": {
        "properties": {
          "intent": {
            "type": "object",
            "required": ["chain", "protocol", "target", "asset", "amount", "recipient"],
            "properties": {
              "chain": { "enum": ["base", "solana"] },
              "protocol": { "type": "string", "minLength": 2, "maxLength": 64 },
              "target": { "type": "string", "minLength": 2, "maxLength": 128 },
              "asset": { "type": "string", "minLength": 2, "maxLength": 32 },
              "amount": { "$ref": "#/$defs/numericOrString" },
              "recipient": { "type": "string", "minLength": 32, "maxLength": 64 },
              "amountType": { "enum": ["asset", "shares"] }
            },
            "additionalProperties": false
          }
        }
      }
    },
    {
      "if": {
        "properties": { "operation": { "const": "hyperliquid.spot.order" } },
        "required": ["operation"]
      },
      "then": {
        "properties": {
          "intent": {
            "type": "object",
            "required": ["market", "side", "amount", "price"],
            "properties": {
              "market": { "type": "string", "minLength": 3, "maxLength": 32 },
              "side": { "enum": ["buy", "sell"] },
              "amount": { "$ref": "#/$defs/numericOrString" },
              "price": { "anyOf": [{ "const": "market" }, { "$ref": "#/$defs/numericOrString" }] },
              "slippageBps": { "type": "integer", "minimum": 0, "maximum": 10000 },
              "tif": { "enum": ["Alo", "Ioc", "Gtc"] },
              "cloid": { "type": "string", "pattern": "^0x[a-fA-F0-9]{32}$" }
            },
            "additionalProperties": false
          }
        }
      }
    },
    {
      "if": {
        "properties": { "operation": { "const": "hyperliquid.perp.order" } },
        "required": ["operation"]
      },
      "then": {
        "properties": {
          "intent": {
            "type": "object",
            "required": ["market", "side", "amount", "price"],
            "properties": {
              "market": { "type": "string", "minLength": 1, "maxLength": 32 },
              "side": { "enum": ["buy", "sell"] },
              "amount": { "$ref": "#/$defs/numericOrString" },
              "price": { "anyOf": [{ "const": "market" }, { "$ref": "#/$defs/numericOrString" }] },
              "reduceOnly": { "type": "boolean" },
              "leverage": { "$ref": "#/$defs/numericOrString" },
              "slippageBps": { "type": "integer", "minimum": 0, "maximum": 10000 },
              "tif": { "enum": ["Alo", "Ioc", "Gtc"] },
              "cloid": { "type": "string", "pattern": "^0x[a-fA-F0-9]{32}$" },
              "referencePrice": { "$ref": "#/$defs/numericOrString" }
            },
            "additionalProperties": false
          }
        }
      }
    },
    {
      "if": { "properties": { "operation": { "const": "transfer" } }, "required": ["operation"] },
      "then": {
        "properties": {
          "intent": {
            "type": "object",
            "required": ["chain", "asset", "amount", "to"],
            "properties": {
              "chain": { "enum": ["base", "solana"] },
              "asset": { "type": "string", "minLength": 2, "maxLength": 32 },
              "amount": { "$ref": "#/$defs/numericOrString" },
              "to": { "type": "string", "minLength": 32, "maxLength": 64 },
              "memo": { "type": "string", "maxLength": 256 }
            },
            "allOf": [
              {
                "if": {
                  "properties": { "chain": { "const": "base" } },
                  "required": ["chain"]
                },
                "then": {
                  "properties": { "asset": { "const": "ETH" } },
                  "required": ["asset"]
                }
              },
              {
                "if": {
                  "properties": { "chain": { "const": "solana" } },
                  "required": ["chain"]
                },
                "then": {
                  "properties": { "asset": { "const": "SOL" } },
                  "required": ["asset"]
                }
              }
            ],
            "additionalProperties": false
          }
        }
      }
    },
    {
      "if": { "properties": { "operation": { "const": "send" } }, "required": ["operation"] },
      "then": {
        "properties": {
          "intent": {
            "type": "object",
            "required": ["chain", "asset", "amount", "to"],
            "properties": {
              "chain": { "enum": ["base", "solana"] },
              "asset": { "type": "string", "minLength": 2, "maxLength": 32 },
              "amount": { "$ref": "#/$defs/numericOrString" },
              "to": { "type": "string", "minLength": 32, "maxLength": 64 },
              "purpose": { "type": "string", "maxLength": 256 },
              "memo": { "type": "string", "maxLength": 256 }
            },
            "allOf": [
              {
                "if": {
                  "properties": { "chain": { "const": "base" } },
                  "required": ["chain"]
                },
                "then": {
                  "properties": { "asset": { "const": "ETH" } },
                  "required": ["asset"]
                }
              },
              {
                "if": {
                  "properties": { "chain": { "const": "solana" } },
                  "required": ["chain"]
                },
                "then": {
                  "properties": { "asset": { "const": "SOL" } },
                  "required": ["asset"]
                }
              }
            ],
            "additionalProperties": false
          }
        }
      }
    },
    {
      "if": {
        "properties": { "operation": { "const": "hyperliquid.cancel" } },
        "required": ["operation"]
      },
      "then": {
        "properties": {
          "intent": {
            "type": "object",
            "required": ["venue", "market", "orderRef"],
            "properties": {
              "venue": { "enum": ["spot", "perp"] },
              "market": { "type": "string", "minLength": 1, "maxLength": 32 },
              "orderRef": { "$ref": "#/$defs/orderRef" }
            },
            "additionalProperties": false
          }
        }
      }
    },
    {
      "if": {
        "properties": { "operation": { "const": "hyperliquid.modify" } },
        "required": ["operation"]
      },
      "then": {
        "properties": {
          "intent": {
            "type": "object",
            "required": ["venue", "market", "orderRef", "side", "amount", "price"],
            "properties": {
              "venue": { "enum": ["spot", "perp"] },
              "market": { "type": "string", "minLength": 1, "maxLength": 32 },
              "orderRef": { "$ref": "#/$defs/orderRef" },
              "side": { "enum": ["buy", "sell"] },
              "amount": { "$ref": "#/$defs/numericOrString" },
              "price": { "anyOf": [{ "const": "market" }, { "$ref": "#/$defs/numericOrString" }] },
              "reduceOnly": { "type": "boolean" },
              "leverage": { "$ref": "#/$defs/numericOrString" },
              "slippageBps": { "type": "integer", "minimum": 0, "maximum": 10000 },
              "tif": { "enum": ["Alo", "Ioc", "Gtc"] },
              "cloid": { "type": "string", "pattern": "^0x[a-fA-F0-9]{32}$" },
              "referencePrice": { "$ref": "#/$defs/numericOrString" }
            },
            "additionalProperties": false
          }
        }
      }
    }
  ],
  "$defs": {
    "numericOrString": {
      "anyOf": [{ "type": "number" }, { "type": "string", "minLength": 1, "maxLength": 64 }]
    },
    "orderRef": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": { "enum": ["oid", "cloid"] },
        "value": {
          "anyOf": [
            { "type": "integer", "minimum": 0 },
            { "type": "string", "minLength": 1, "maxLength": 128 }
          ]
        }
      },
      "additionalProperties": false
    }
  }
}
