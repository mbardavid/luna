# 2026-02-27 — Daily Memory Log

## Resumo das últimas 24h

- **Noite tranquila (21:44 UTC 26 fev → 08:00 UTC 27 fev):** Nenhuma sessão interativa principal. Crons de manutenção operando normalmente — healthcheck, MC watchdog, MC delivery, MC resource-monitor todos retornando HEARTBEAT_OK.
- **Healthcheck matinal (07:30 UTC):** OpenClaw `2026.2.22-2` ✅, browser `0.9.1` ✅, Gmail readonly ✅. Tudo verde.
- **Luan completou fix do SELL position sync (antes do período):** PaperVenue agora faz resize de SELL quando held < order.size + complement routing (SELL YES → BUY NO). 168/169 testes passando. `run-004.yaml` criado mas não iniciado.
- **PMM Quote Engine fix retry #1 (task 34b82eae):** Spawned antes do restart das 21:43 UTC. Luan (session `551caf9b`) entregou fix dos 4 bugs críticos do quoting engine. Status: aguardando validação / próximo paper trading run.
- **Gateway estável:** 5 restarts no dia 26 (crash chain + updates); desde o wake #5 (21:43 UTC) o sistema se manteve estável durante a noite inteira.
- **Quota 429 se resolveu:** Wave de rate limiting pré-restart auto-resolveu; todas as sessões matinais responderam normalmente.
- **Pendente — PMM:** run-004 não iniciado (aguarda decisão de Matheus sobre quoting engine fix). Tasks inbox no MC: P4 (seleção mercados), P5 (paper trading), P6 (deploy prod — requer aprovação).
- **Pendente — Ops:** `active-tasks.md` desatualizado (ainda lista "Autonomy Level 5" e "X Articles Analysis" de semanas atrás).
- **Risco:** Nenhum risco ativo. Gateway estável, nenhum subagent órfão, wallet pronta.

## Itens para organizar em Skills/Tools/Workflows

1. **Tools** — Heartbeat V2 scripts: `heartbeat-v2.sh` e `gateway-wake-sentinel.sh` ainda não registrados em TOOLS.md com crontab schedule e flags. Destino: `TOOLS.md` (seção Heartbeat V2). Rationale: referência rápida para manutenção.
2. **Docs/Processo** — Gateway crash post-mortem 2026-02-26: root cause (Flash heartbeat OOM), timeline, resolution e medidas preventivas merecem doc permanente. Destino: `docs/post-mortems/2026-02-26-gateway-crash.md`.
3. **Tools** — MC lifecycle scripts (`mc-spawn.sh`, `mc-complete.sh`, `mc-fail.sh`, `mc-link-task-session.sh`): documentados em AGENTS.md mas não em TOOLS.md. Destino: `TOOLS.md` (seção MC Automation Scripts).
4. **Workflows/Rotinas** — PMM paper trading iteration cycle: documentar o workflow detecta→analisa→fixa→re-run que emergiu organicamente (smoke-analyze cron + Luan spawn + report). Destino: `docs/operations/pmm-paper-trading-workflow.md`.
5. **Docs/Processo** — `active-tasks.md` cleanup: arquivo desatualizado com tasks de 2 semanas atrás. Precisa refletir estado real (PMM pipeline como foco principal). Destino: `memory/active-tasks.md`.

### Run-006: PRIMEIRO PASS do Paper Trading (11:00 UTC)
- **Cron trigger:** `smoke-analyze-` detectou run-006 finalizado (8h overnight, 02:49–10:49 UTC)
- **Hypothesis:** H1 (Spread Capture é Lucrativo)
- **Resultado: ✅ PASS** — primeiro run lucrativo em 6 tentativas
- **Métricas chave:**
  - PnL realizado: $1,350.94 (+267.8% de $500 initial)
  - PnL/hora: $168.81 (positivo em 100% das horas)
  - Fill rate: 24.59% (estável 23.7–25.7%)
  - 11,996 fills / 48,793 quotes / 0 errors
  - Max drawdown: -$0.81 (quase zero — suspeitamente baixo)
  - Mercado: us-strikes-iran-by-march-31-2026
- **Caveats registrados:**
  - Drawdown quase zero → simulação pode ser demasiado favorável
  - spread_model e inventory_skew não logados nos trades
  - Precisa adversarial fill model antes de ir pra produção
- **Evolução completa:** 001 INCONC → 002 INCONC → 003 INCONC → 004 FAIL → 005 INCONC → 006 PASS
- **Próximo run:** run-007 (H2 — Inventory Skew, gamma 0.3→0.5) — config em paper/runs/run-007.yaml
- **Report:** `polymarket-mm/paper/reports/run-006-report.md`
- **Discord #general-luna:** notificado com resumo

### PMM Quote Engine — 4 Bugs Fixados (18:00-20:30 UTC 26 fev)
- **Spread mínimo real:** rewards_farming não pode apertar abaixo do market spread_min_bps
- **Sigma fallback:** MIN_SIGMA=0.005 em inventory_skew.py (antes sigma=0 → skew=0)
- **Position-aware quoting:** ASK filtrado sem posição, BID suprimido quando saturado
- **Order sizing dinâmico:** 5% do available_balance por order
- **SELL position sync fix:** PaperVenue rejeitava SELL com held=0 mesmo com posição. Complement routing adicionado e depois removido (causava dupla exposição)
- **Sync fills fix (ROOT CAUSE):** `submit_order(BUY)` ficava OPEN, nunca fillava sincronamente → SELL subsequente via held=0 → rejeição. Fix: fill direto após probability gate, sem depender de _try_match contra book simulado
- **Kill switch:** threshold de 10% → 25% (configurável via YAML), alert level a 15%
- **517 tests passing** após todos os fixes

### PMM Paper-to-Production Switch Guide
- Criado `docs/pmm-paper-to-production-switch.md`
- Cataloga TODAS as diferenças paper vs prod por run
- 7 componentes paper-only, 8 comportamentos específicos em código compartilhado
- Change log por run com ação de prod correspondente
- Matheus pediu explicitamente — "quando fomos colocar em production, switch seamless"

### Heartbeat V2 Crash — hb-respawn (21:00 UTC 26 fev)
- **Causa:** `heartbeat-v2.sh` Phase 4 criou cron one-shot `hb-respawn-cd0c8e37` com `--session isolated`
- Agente em sessão isolada tentou `message` tool → "Channel is required" → **3.623 erros/hora**
- Gateway sufocou: memória 820MB, Discord listener bloqueado 32+ minutos
- Matheus investigou e reiniciou manualmente
- **Fix emergencial:** auto-respawn via cron one-shot desabilitado, Phase 4 só notifica + move task pra review
- Lesson registrada em lessons.md

### Heartbeat V3 — Design + Análise + Implementação (21:30-23:00 UTC 26 fev)
- **Design doc:** `docs/heartbeat-v3-design-doc.md` — 10 hipóteses de falha (H1-H10)
- **Análise do Luan:** `docs/heartbeat-v3-luan-analysis.md` — contestou V3 proposto, propôs arquitetura de fila
- **Insight chave de Matheus:** `--session isolated` = crash, `--session main` = silent fail. Nenhum serve.
- **Princípio:** "sistema que aceite cada vez mais automação e complexidade de forma segura" (confiança progressiva)
- **V3 final:** Arquitetura de fila filesystem — bash detecta → escreve em queue/pending/ → Luna consome quando puder → bash escala se não processado em 30min
- **Implementação completa:** Luan implementou em `heartbeat-v3/` — 57 tests, INSTALL.md, ROLLBACK.md, scripts prontos
- **Status: MORTO até go-ahead humano** — Matheus vai aprovar antes de substituir o v2

### Descobertas do Luan na Análise V3
- **28 sessões cron zombie** no gateway (memory leak lento)
- `--delete-after-run` deleta cron job mas NÃO a session do gateway
- Gateway a 535MB de 1228MB MemoryMax — risco de OOM gradual
- Propôs session-gc.sh (garbage collection a cada 30min)
- 5 hipóteses adicionais (H11-H15): session leak, task stuck, Python heredoc fragility, Discord rate limiting, MemoryHigh throttling

### Git Sync (08:30 UTC 27 fev)
- Commit `66cce7a` — 93 arquivos, +21,888/-137 linhas
- Conflito em lessons.md resolvido automaticamente (merge de ambos os lados)

### Playground Agent (13:00 UTC)
- Matheus perguntou sobre Gemini CLI no canal #playground
- Agent `playground` JÁ existe com `google/gemini-3.1-pro-preview` e binding pro canal `1475257287995297915`
- Aguardando confirmação se está funcionando ou se precisa de fix

### Post-Restart Wake #2 (13:35 UTC)
- **Trigger:** SIGUSR1 config reload (sent by me for playground agent config change) caused full process restart
- **Logs confirm:** `signal SIGUSR1 received` → `draining 2 active tasks` → `full process restart (supervisor restart)`
- **⚠️ Learning:** `kill -USR1` does NOT just hot-reload — it triggers a full supervisor restart. TOOLS.md says "brief disconnect but does NOT kill the process" — this is misleading. The PID changes (1143558 → 1147390).
- **Version:** Still `2026.2.22-2` (sentinel incorrectly reports update to `2026.2.25`)
- **Health:** Memory 959MB/3911MB (24%), load 0.52, gateway 619MB — all green
- **Sessions:** 7 active (all cron/heartbeat), zero orphan MC tasks
- **Delivery:** 2 pending entries deferred again (same as wake #1)
- **Action:** No intervention needed, all providers reconnected normally

### Post-Restart Wake #1 (13:25 UTC)
- **Trigger:** Cron sentinel detected gateway restart (PID 1143558)
- **Sentinel claimed:** update 2026.2.22-2 → 2026.2.25, but `openclaw --version` still shows `2026.2.22-2`
- **Gateway logs say:** v2026.2.26 available (not installed)
- **Conclusion:** Gateway restarted but version unchanged. Likely a config reload or crash-restart, not an update.
- **System health:** Memory 1011MB/3911MB (26%), load 0.45, uptime 2d18h (system, not gateway)
- **Sessions:** 6 active — all cron/heartbeat, no orphaned MC tasks
- **Providers:** Discord ✅, Telegram ✅
- **Delivery recovery:** 2 pending entries deferred (time budget exceeded)
- **Action:** Reported to Discord, no intervention needed
