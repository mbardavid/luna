# 2026-02-25 — Daily Memory Log

## Resumo das últimas 24h

- **Polymarket Market Maker — projeto bootstrapped:** Luan (subagente) completou research consolidado (`research/polymarket-mm-research.md`) e plano detalhado (`docs/polymarket-mm-plan.md`, 30K chars) baseado em análises do GPT 5.2 Pro + Gemini 3 Deep Think. Scaffold do projeto criado em `polymarket-mm/` com ~15 diretórios (core, strategy, execution, models, tests, monitoring, etc.), pyproject.toml, Dockerfile, docker-compose. Fase 1 de codificação iniciada.
- **Bird CLI instalado (v0.8.0):** CLI do X/Twitter via GraphQL + cookie auth. Conta `@lunabardabot` autenticada. Credenciais persistidas em `.bashrc` + systemd drop-in para o gateway.
- **Quant Strategist vinculado ao Discord:** Canal `1475989470883872860` recebeu binding no `openclaw.json`.
- **Lição crítica registrada:** Matheus cobrou reação automática a falhas de subagentes. Regra documentada em AGENTS.md + lessons.md: quando subagente falha, investigar + agir imediatamente sem esperar o humano perguntar.
- **Spawning rules consolidadas:** `memory/spawning-rules.md` criado/atualizado com 5 golden rules para orquestração de subagentes + MC tracking.
- **Plano de estabilidade pós-crash documentado:** `docs/stability-plan-crash-2026-02-24.md` — diagnóstico de pressão de memória por sessões gigantes + tempestade de crons no boot. Plano de 3 camadas (higiene de sessões, escalonamento de crons, limites de heap).
- **Sem atividade interativa nas últimas ~12h** (madrugada 24→25 fev). Crons de manutenção operando normalmente. Único commit no período: sync diário às 19:30 UTC do dia 24.
- **Decisões pendentes:** Execução sequencial das fases do Polymarket MM via MC/heartbeat (task drain automático); documentação permanente dos itens de taxonomia acumulados dos últimos dias.
- **Riscos:** Reasoning leak do `claude-opus-4-6-thinking` no Discord persiste (upstream). Edits concorrentes multi-agent sem coordenação. Sessões `.jsonl` grandes podem causar heap pressure no gateway restart.

## Itens para organizar em Skills/Tools/Workflows

1. **Tools** — Bird CLI (X/Twitter): registrar em TOOLS.md com versão, método de auth (cookie), conta vinculada, e env vars necessárias. Destino: `TOOLS.md` (seção Bird CLI / X Access).
2. **Workflows/Rotinas** — Task drain automático via HEARTBEAT.md: documentar o fluxo de puxar próxima task inbox do MC quando não há `in_progress`. Já está em HEARTBEAT.md mas precisa de doc operacional separada. Destino: `docs/operations/mc-task-drain-flow.md`.
3. **Docs/Processo** — Spawning rules para subagentes: já documentadas em `memory/spawning-rules.md`, mas deveriam migrar para doc permanente. Destino: `docs/operations/subagent-spawning-rules.md`.
4. **Docs/Processo** — Plano de estabilidade gateway (sessões + crons + heap): extrair ações concretas do `docs/stability-plan-crash-2026-02-24.md` em checklist operacional. Destino: `docs/runbooks/gateway-stability-checklist.md`.
5. **Skills** — Polymarket MM como projeto de engenharia: registrar stack, dependências, e status do projeto. Destino: `docs/projects/polymarket-mm-status.md`.
6. **Tools** — Quant Strategist Discord binding: documentar canal ID e propósito em TOOLS.md. Destino: `TOOLS.md` (seção Discord Bindings).

## Atividade de Sessão

- Nenhuma sessão interativa principal ativa nas últimas 12h (período noturno).
- Crons de manutenção (healthcheck, memory log, github sync) operando conforme esperado.
- Luan executou fases de codificação do Polymarket MM durante a madrugada (artefatos em `polymarket-mm/`).

## Atividade da Sessão (manhã/tarde 25 fev — 05:00-14:00 UTC)

### Polymarket Market Maker — Execução Completa
- **Todas as 11 fases (0-10) concluídas** pelo Luan durante a noite/manhã
- 59 módulos Python, 449 testes passando
- Fases executadas sequencialmente via spawn contínuo na mesma sessão (não via heartbeat)
- MC atualizado com todas as fases como `done`, descriptions com referência ao plano + entregáveis + validação

### Refator A2A (fast-path / slow-path)
- Decisão arquitetural: quant executa direto no CLOB (fast-path), operações on-chain delegadas ao Crypto-Sage via TaskSpec (slow-path)
- Novo módulo `a2a/` com CTFDelegate, TaskSpec, README
- EIP-712 signer mantido no quant (necessário para ordens CLOB)
- web3_infra/ simplificado (apenas eip712_signer.py usado diretamente)
- 463 testes passando após refactor

### Configurações Finalizadas
- **Polymarket CLOB API keys derivadas** automaticamente da wallet Base via py-clob-client
- Conexão testada: server time OK, 1000+ markets acessíveis
- `.env` criado com todas credenciais (chmod 600)
- Wallet: `0xa1464EB4f86958823b0f24B3CF5Ac2b8134D6bb1` (mesma da Base)

### Crypto-Sage Reconfigurado
- Crypto-sage agora é o blockchain operator: docs, .env, env vars do gateway copiados
- IDENTITY.md, SOUL.md, AGENTS.md, TOOLS.md atualizados com identidade do blockchain-operator
- Env vars (SOLANA, HYPERLIQUID, BASE, DEBRIDGE) carregadas no gateway via systemd drop-in
- Pedido de withdraw USDC Hyperliquid → Polygon enviado ao crypto-sage

### Bird CLI
- Instalado v0.8.0, conta @lunabardabot autenticada
- Credenciais (auth_token + ct0) persistidas em .bashrc + systemd drop-in

### Quant Strategist
- Binding adicionado ao canal Discord `1475989470883872860`

### Lições Documentadas (novas)
1. **Reagir automaticamente a falhas de subagentes** — não esperar o humano cobrar
2. **Execução contínua** — quando instrução é "execute o plano", não parar entre fases
3. **Pós-restart: reassumir tarefas imediatamente** — sem esperar prompt
4. **Tasks do MC precisam de contexto completo** — plano fonte + entregáveis + validação
5. **NUNCA spawnar sem card no MC** — criar card primeiro, spawn depois (cobrado 2x pelo Matheus)

### Pendente
- Withdraw USDC da Hyperliquid → Polygon (aguardando crypto-sage)
- Verificar gas (MATIC/POL) na Polygon
- Montar plano de dry run e testes com Matheus
- Heartbeat com modelo mais rápido (backlog MC)

## Sessão da tarde (14:00–16:44 UTC)

### Operações Crypto
- **Saque Hyperliquid → Arbitrum concluído:** 230 USDC sacados com sucesso pelo crypto-sage. Perp→Spot + Withdraw3 para Arbitrum. Saldo confirmado: 229.81 USDC em Arbitrum.
- **Diagnóstico de auth:** Agent wallet key (`0x9a00...`) NÃO serve para transfers/withdrawals na Hyperliquid (só orders). O crypto-sage usou `BASE_PRIVATE_KEY` como fallback (é a main account key). Luan criou conector standalone + CLI + 13 testes.
- **HYPERLIQUID_PRIVATE_KEY** adicionada ao systemd drop-in como alias da BASE_PRIVATE_KEY.
- **Arbitrum + Polygon** adicionados ao portfolio do crypto-sage. 5 chains agora: Base, Solana, Hyperliquid, Arbitrum, Polygon.

### Consolidação de Workspaces
- **Dois workspaces crypto-sage consolidados em um:** `workspace-crypto-sage/` (identity files) + `agents/blockchain-operator/` (código produção) → tudo em `workspace-crypto-sage/`. Config do openclaw.json atualizado. Backup em `/tmp/`.
- **ConsolidatedBalanceService** atualizado com ArbitrumConnector e PolygonConnector.
- `/saldo` agora mostra 5 chains com $412.96 total.

### MC Automation Upgrade
- **6 entregáveis implementados pelo Luan:**
  - `config/mc-agent-ids.json` — lookup table de agent IDs
  - `scripts/mc-spawn.sh` — prep atômico (cria task + payload + assigned_agent_id)
  - `scripts/mc-complete.sh` — marca done + summary + delivery
  - `scripts/mc-fail.sh` — retry logic (inbox se < max, review se >= max)
  - Watchdog upgrade — detecta sessions encerradas sem MC update
  - AGENTS.md atualizado com referências aos scripts
- **Spec documentado:** `docs/mc-automation-upgrade-spec.md`
- **Limpeza do board:** 20 tasks QA/obsoletas arquivadas. Board zerado: 0 inbox, 0 review.

### Heartbeat ativado
- `agents.defaults.heartbeat.every = 30m` + `model = gemini-3-flash`
- HEARTBEAT.md atualizado com pre-flight concurrency check (cron guard + subagents + MC in_progress)
- `scripts/mc-cron-guard.sh` criado para prevenir concorrência heartbeat/crons

### A2A
- `agentToAgent.enabled = true` e `sessions.visibility = all` habilitados no gateway
- `sessions_send` funciona para A2A mas `sessions_spawn` é o padrão correto para delegação
- Mensagens bot→bot no Discord não funcionam (mesmo bot token, self-messages ignoradas)

### Lições registradas em lessons.md
1. Nunca travar turno com `sessions_send` timeout > 30s
2. Updates intermediários obrigatórios antes de cadeias longas de tool calls
3. A2A via `sessions_spawn` (fire-and-forget), não Discord
4. MC card obrigatório no turno do spawn (checklist: card → spawn → link)
5. Atualizar MC no mesmo turno que recebe resultado de subagent

### Task em progresso
- NautilusTrader strategy validator — Luan spawnado (MC `b6700d7f`)

## Sessão da tarde/noite (17:00–19:18 UTC)

### PMM Production Pipeline — P1-P5 em execução
- **P1 ✅ Bridge USDC Arbitrum → Polygon:** 229.56 USDC bridged via deBridge (DLN). Order ID: `0xbf074d...`. Tx confirmada on-chain. Saldo Arbitrum: 0.045 USDC + 0.000008 ETH.
- **P2 ✅ Polymarket API credentials:** Geradas via py_clob_client. API key, secret, passphrase salvos em systemd drop-in (`polymarket-env.conf`). L2 auth testada OK. Blocker: 0 MATIC/POL para gas (allowances).
- **P3 ✅ Conectar APIs reais:** Luan entregou: rest_client.py (real ClobClient wrap), ws_client.py (WS real com reconnect), live_execution.py, 7/8 testes de integração passando contra prod. 463 testes totais passando. Blocker: 0 POL para gas + 0 USDC.e na wallet.
- **P4 ⏳ Seleção de mercados** — próximo a spawnar
- **P5 ⏳ Paper trading live** — aguardando P4

### PMM MC Tasks
- `9e2a8dc7` P1 — done
- `98e69ad8` P2 — done
- `a2f29907` P3 — done (Luan sessão `8c4f2acd`)
- `051146d7` P4 — inbox
- `4b38f7a7` P5 — inbox
- `34e8907c` P6 — inbox (requer aprovação Matheus)
- `cd1ae6ed` — MC delivery notifications → #notifications (backlog)

### Blocker descoberto: USDC vs USDC.e
- A wallet tem 229.56 USDC (native, `0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359`) mas Polymarket usa **USDC.e** (`0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174`)
- Também precisa de ~0.1 POL para gas (set allowances)
- Resolução pendente: swap USDC→USDC.e ou verificar se Polymarket aceita USDC native

### Heartbeat diagnosticado e corrigido
- **Heartbeat está rodando:** gemini-3-flash batendo a cada ~3-5min (confirmado nos logs)
- **Bug encontrado:** cron guard no HEARTBEAT.md tratava crons de manutenção (watchdog, delivery, resource-monitor) como "trabalho ativo", fazendo Flash sempre retornar HEARTBEAT_OK
- **Fix:** removido cron guard do pre-flight. Agora só checa `subagents list` (subagents reais de trabalho)
- Crons de manutenção NÃO contam como trabalho ativo

### Lições
- **Auto-chain sequential tasks:** quando Matheus diz "execute P1-P5", cada conclusão de fase DEVE spawnar a próxima automaticamente no mesmo turno. Nunca esperar heartbeat ou próxima mensagem.
- **Crons ≠ trabalho ativo:** heartbeat pre-flight deve ignorar crons de manutenção periódicos

### Outros
- Repo público (github.com/mbardavid/luna) — forks não podem ser desabilitados em repos pessoais (só org)
- Git sync: commit `73135c4` com 189 arquivos (PMM F4-F10, MC automation, crypto-sage consolidation)
- NautilusTrader task (`b6700d7f`) spawnada para Luan (research)

## 2026-02-26 (madrugada) — Gateway crashes e fixes

### Gateway crash chain
1. **01:31 UTC** — Heartbeat Flash spammou notificações sem `channel: discord` → retry storm → OOM → SIGKILL
2. Processo órfão sobreviveu segurando porta 18789 → crash loop do systemd user
3. Matheus matou processo órfão manualmente
4. **02:04 UTC** — Luna mandou SIGUSR1 pra reload config → gateway morreu (exit 0) → system-service subiu no lugar
5. **02:15 UTC** — Luna tentou `sudo systemctl stop` pra resolver conflito → se matou (3x)
6. Matheus resolveu: desabilitou user-service, migrou drop-ins, habilitou system-service único

### Fixes implementados
- **Heartbeat AI removido:** `agents.defaults.heartbeat` deletado do openclaw.json
- **`heartbeat-check.sh` criado:** Script bash puro, zero tokens, determinístico, crontab a cada 10min
- **Absorve failure-detector:** mc-failure-detector cron removido (lógica incorporada no heartbeat-check.sh)
- **State tracking:** `/tmp/.heartbeat-check-state.json` previne spam (dedup por inbox count + failure labels)
- **HEARTBEAT.md atualizado** com anti-spam e `channel: discord` obrigatório
- **TOOLS.md atualizado** com regras operacionais do gateway (nunca stop/restart via exec)
- **Lição:** Crypto-sage é executor puro — Flash entrou em loop de web_fetch 15x (38M tokens queimados)
