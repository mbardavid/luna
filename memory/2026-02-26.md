# 2026-02-26 — Daily Memory Log

## Resumo

### PMM Blockers Resolvidos ✅
- **Luan subagente** (`2cde40de`) completou todas as 3 tarefas da task `92b5216d`:
  1. POL gas validado: ~8.38 POL na wallet
  2. 228 USDC native → 227.96 USDC.e via ParaSwap swap on-chain
  3. Todas as 6 allowances setadas: USDC.e → CTF Exchange, Neg Risk CTF Exchange, Neg Risk Adapter + CTF ERC1155 → mesmos 3 contratos
- Wallet `0xa1464EB4f86958823b0f24B3CF5Ac2b8134D6bb1` **pronta para trading** no Polymarket
- Task `92b5216d` marcada como done no MC
- Task duplicada `434b513b` também marcada como done

### Estado Atual
- **4 tasks inbox no MC:** P4 (seleção de mercados), P5 (paper trading), P6 (deploy production), MC delivery notifications
- **Nenhum subagent ativo**
- **Gateway estável** — system-service rodando, healthcheck OK

### Healthcheck Diário (07:30 UTC)
- OpenClaw `2026.2.22-2` — gateway running ✅
- Browser tooling OK — `agent-browser 0.9.1` ✅
- Gmail readonly token válido ✅

## Atividade de Sessão (madrugada 26 fev — 00:00–08:00 UTC)

### Gateway Crash Chain (01:31–02:15 UTC)
- **01:31** — Heartbeat Flash spammou notificações sem `channel: discord` → retry storm → OOM → SIGKILL
- Processo órfão segurando porta 18789 → crash loop systemd
- **02:04** — SIGUSR1 reload config matou gateway (exit 0) → system-service assumiu
- **02:15** — `sudo systemctl stop` executado pela Luna → se matou 3x
- **Matheus resolveu:** desabilitou user-service, migrou drop-ins, habilitou system-service único

### Fixes Implementados (02:15–03:00 UTC)
- Heartbeat AI (gemini-3-flash) removido do openclaw.json — causa raiz do crash
- `heartbeat-check.sh` criado: bash puro, zero tokens, determinístico, crontab 10min
- Absorveu mc-failure-detector (cron removido)
- State tracking em `/tmp/.heartbeat-check-state.json` com dedup
- HEARTBEAT.md atualizado com anti-spam + `channel: discord` obrigatório
- TOOLS.md atualizado com regras operacionais do gateway (NUNCA stop/restart via exec)

### Heartbeat V2 (Luan — ~02:30 UTC)
- Luan completou implementação completa do heartbeat-v2:
  - `scripts/heartbeat-v2.sh` (~32KB) — 9 fases, circuit breaker, rate limit, resource check, FIFO inbox pull
  - `scripts/gateway-wake-sentinel.sh` (~10KB) — PID-based boot detection, briefing injection
  - Crontab atualizado: v1 removido, v2 (`*/10`) + sentinel (`* * * *`) adicionados
  - 12 testes executados — todos passando
- MC task `e746f323` marcada como done

### Lição Crítica Registrada
- **Crypto-sage é executor puro:** Flash entrou em loop de web_fetch 15x (38M tokens queimados) tentando operar como crypto-sage no Discord
- **NUNCA parar/reiniciar gateway via exec** — mata a Luna junto; systemd cuida do restart

### Crons Operacionais (07:00–08:00 UTC)
- Healthcheck diário: OpenClaw `2026.2.22-2` ✅, browser `0.9.1` ✅, Gmail token ✅
- MC watchdog, delivery, resource-monitor — HEARTBEAT_OK (nada pendente)
- hb-test-verify (02:59 UTC) — HEARTBEAT_V2_TEST_OK confirmado

### Estado Atual
- **4 tasks inbox no MC:** P4 (seleção mercados), P5 (paper trading), P6 (deploy prod), MC delivery notifications
- **Nenhum subagent ativo**
- **Gateway estável** — system-service rodando, heartbeat v2 instalado
- **Wallet pronta:** 0xa146... com ~228 USDC.e + ~8.38 POL na Polygon, allowances setadas

## Resumo das últimas 24h

- **Gateway crash chain resolvido (01:31–02:15 UTC):** Flash heartbeat causou OOM → crash loop → Matheus resolveu unificando em system-service. User-service desabilitado permanentemente.
- **Heartbeat V2 implementado e instalado:** Luan entregou heartbeat-v2.sh (bash puro, 9 fases, circuit breaker, rate limit) + gateway-wake-sentinel.sh. Substituiu heartbeat AI (Flash) que era instável e caro.
- **PMM blockers resolvidos:** POL gas validado (~8.38), USDC→USDC.e swap concluído (227.96), 6 allowances setadas. Wallet pronta para trading no Polymarket.
- **Regras operacionais do gateway documentadas:** NUNCA parar/reiniciar via exec (mata Luna). Diagnóstico somente leitura. Config reload via SIGUSR1 (non-disruptive, mas pode causar brief disconnect).
- **Pendente:** P4 (seleção de mercados), P5 (paper trading), P6 (deploy prod — requer aprovação Matheus). Nenhum subagent ativo.
- **Risco:** Flash queimou 38M tokens em loop de web_fetch como crypto-sage (lição registrada).

## Itens para organizar em Skills/Tools/Workflows

1. **Tools** — Heartbeat V2 scripts: registrar `heartbeat-v2.sh` e `gateway-wake-sentinel.sh` em TOOLS.md com localização, crontab schedule, e flags disponíveis (`--dry-run`, `--verbose`, `--reset-circuit-breaker`). Destino: `TOOLS.md` (seção Heartbeat V2).
2. **Docs/Processo** — Gateway operational rules: as regras de "nunca stop/restart via exec" já estão em TOOLS.md mas merecem um runbook dedicado com cenários de diagnóstico. Destino: `docs/runbooks/gateway-operations.md`.
3. **Workflows/Rotinas** — Heartbeat v1→v2 migration: documentar o que mudou (AI → bash), o que foi absorvido (mc-failure-detector), e como testar. Destino: `docs/operations/heartbeat-migration-v1-v2.md`.
4. **Tools** — MC lifecycle scripts: `mc-spawn.sh`, `mc-complete.sh`, `mc-fail.sh`, `mc-link-task-session.sh` já estão documentados em AGENTS.md mas não em TOOLS.md. Destino: `TOOLS.md` (seção MC Automation Scripts).
5. **Docs/Processo** — Gateway crash post-mortem 2026-02-26: documentar root cause (Flash heartbeat OOM), timeline, resolution, e preventive measures. Destino: `docs/post-mortems/2026-02-26-gateway-crash.md`.
