# 2026-03-02 Session Log

## PMM prod-002 Launched
- Killed prod-001 (archived data to `archive-prod-001/`). prod-001 had 98.6% rejections (all SELLs).
- **Complement routing implemented by Luan** â€” 655 tests, 14 new. SELL YES â†’ BUY NO when no position held.
- **Geoblock fix**: `py_clob_client` uses global `httpx.Client` without proxy. Monkey-patched in `production_runner.py` to use `socks5://127.0.0.1:9050` via `socksio`. Env var `POLYMARKET_PROXY` overrides.
- **prod-002 LIVE** on market "Will the Iranian regime fall by June 30?" (mid=0.475, vol=$1.1M, liq=$600K). First 4 orders all accepted, 2 instant fills. Zero rejections.
- Config: spread 30bps, requoting 3s, gamma 0.5, max position 50 shares/side, $25 capital, 24h duration.
- PID: stored in `paper/data/production_trading.pid`, logs in `logs/prod-002.log`.

## Crypto-Sage Portfolio â€” Polymarket Integration Done
- Luan integrated `collectPolymarketPositions()` into `portfolio.mjs`. Fixed broken `import { getBalanceSummary }` â†’ `import { HyperliquidConnector }`.
- `--polymarket` flag for focused Polymarket view. `scripts/update-polymarket-env.sh` for systemd env var generation.
- Env vars (`POLYMARKET_POSITIONS_JSON`, `POLYMARKET_REALIZED_PNL`) still need to be added to systemd drop-in.

## Gateway Memory Crisis & Cleanup
- Gateway at **741MB / 900MB** (82% of high watermark). All CLI commands timing out.
- Root cause: **294 sessions in `sessions.json`** â€” 282 were accumulated cron run sessions never cleaned.
- Fix: Python script pruned 267 dead cron runs (294 â†’ 27 sessions). File went from 2.7MB â†’ 217KB.
- Also cleaned ~35MB of `.deleted` and `.corrupt` transcript files across all agents.
- Post-restart: gateway dropped to **400MB** (~340MB freed).

## CTO AgÃªntico â€” Gateway Restart Authority
- **`scripts/gateway-safe-restart.sh`** created â€” 7-phase safe restart protocol:
  1. Rate limit (max 3/hour) 2. Memory check (>70% watermark) 3. Session cleanup 4. Dry run gate 5. Discord notification 6. State snapshot 7. Restart
- **`cto-risk-policy.json`** updated: gateway restart moved from denylist to "high" risk with conditions.
- **`mc-resource-monitor.sh`** now auto-triggers restart when gateway memory >80% of cgroup watermark.
- **`cto-ops-runbook.md`** updated with gateway restart procedure.
- TOOLS.md updated: restart via script is now allowed (was previously "NUNCA").
- Matheus explicitly authorized this change.

## Post-Restart Recovery System
- **`scripts/gateway-state-snapshot.sh`** â€” captures running state before restart (PMM processes, MC tasks, subagent sessions, PID files).
- **`scripts/gateway-post-restart-recovery.sh`** â€” resumes work after restart (re-launches PMM, moves orphaned MC tasks to inbox, cleans stale sessions, notifies Discord).
- **systemd drop-in `99-post-restart-recovery.conf`** â€” replaced `99-disable-startup-hook.conf`. ExecStartPost now runs recovery script.

## A2A Dispatch â€” Architecture Analysis
- **Confirmed: `sessions.spawn` RPC does NOT exist** in OpenClaw gateway. Only available as AI tool call.
- Available RPC methods: `sessions.list`, `sessions.delete`, `cron.list`, `cron.run`, `health`, `status`, `system-presence`.
- **`openclaw agent`** CLI works for sending messages to agents from bash (~15-25K tokens per call, uses agent's full context).
- **`scripts/mc-fast-dispatch.sh`** created â€” dispatches tasks directly via `openclaw agent` instead of slow queue+nudge.
- **heartbeat-v3.py updated** â€” Phase 9 now tries fast-dispatch first, falls back to queue+nudge.

## A2A Dispatch â€” Open Design Decision
- Matheus identified key gap: MC task descriptions are not self-sufficient for automated dispatch.
- Tasks need: detailed description, acceptance criteria, workspace paths, agent assignment.
- Currently Luna composes detailed task specs at spawn time, not at MC card creation time.
- **Dispatcher agent concept**: lightweight gemini-flash agent that receives "spawn X with task Y" and calls `sessions_spawn`. Reduces dispatch cost from 25K tokens (Opus) to 3K (Flash).
- **Blocker**: tasks need to be written as complete specs at creation time, not enriched later. This is not yet implemented.
- Options discussed: A) Luna writes full specs at creation, B) Smart dispatcher enriches, C) Keep current flow but automate detectionâ†’notification.

## Tor/Geoblock Solution (shared with Matheus's friend)
- Polymarket geoblocks US servers. Solution: Tor SOCKS5 proxy on port 9050.
- `/etc/tor/torrc`: `ExitNodes {jp},{br},{kr},{nl},{cw}` + `StrictNodes 1`.
- Works for API/CLOB. Website has additional Cloudflare protections â€” VPN better for web UI.
- Latency ~900ms (acceptable for MM, not HFT).

## Whisper Transcription Issues
- `local-whisper-transcribe` and direct `faster_whisper` both timeout (SIGTERM) when loading model.
- Multiple attempts failed. Likely memory pressure related (gateway was at 741MB during attempts).
- Need to investigate: may need to run transcription when gateway memory is lower, or use a lighter model.

## Operational Notes
- MC API token not loaded in gateway env after restart â€” needs to be in systemd drop-in or `.bashrc` sourced by scripts.
- MC board appears empty after restart (0 tasks) â€” may be auth issue or data was cleaned.
- Heartbeat V3 operational: 10min interval, 7 phases, circuit breaker, queue escalation.
- 13 cron jobs running stable across CTO-ops infrastructure.

## Dispatcher Agent Implemented
- **Agente `dispatcher`** criado com gemini-flash, workspace mÃ­nimo em `workspace-dispatcher/`.
- Ãšnico propÃ³sito: receber "DISPATCH agent=X" + task spec, chamar `sessions_spawn`.
- Custo: ~3K tokens Flash (~$0.001) vs 25K Opus ($0.30) por dispatch.
- Adicionado ao `openclaw.json` com `allowAgents: [luan, crypto-sage, quant-strategist]`.
- `mc-fast-dispatch.sh` atualizado pra rotear via dispatcher ao invÃ©s de direto pro agente alvo.
- **Gateway restart necessÃ¡rio** pra carregar o novo agente.

## mc-spawn.sh â€” Structured Task Specs
- Adicionadas flags estruturadas: `--objective`, `--context`, `--workspace`, `--files`, `--criteria`, `--constraints`, `--task-file`.
- Script auto-monta description formatada com template (Objective/Context/Workspace/Criteria/Constraints).
- Backward compat mantida: `--task` direto continua funcionando.
- Template documentado em `docs/mc-task-spec-template.md`.

## DecisÃ£o Matheus: OpÃ§Ã£o A para dispatch
- Luna escreve specs completas no momento da criaÃ§Ã£o do card MC (nÃ£o no dispatch).
- Dispatcher (flash) repassa sem enriquecer.
- Luan nasce com seu workspace completo (SOUL, MEMORY, LESSONS) independente de quem spawna.

## Post-Restart Recovery System
- `scripts/gateway-state-snapshot.sh` â€” snapshot antes do restart (PMM, MC tasks, subagents).
- `scripts/gateway-post-restart-recovery.sh` â€” recovery automÃ¡tico (re-lanÃ§a PMM, MC tasks Ã³rfÃ£s â†’ inbox).
- systemd drop-in `99-post-restart-recovery.conf` habilitado (substituiu `99-disable-startup-hook.conf`).

## MC Task Spec v2 â€” Plano + QA + Lessons
- Template expandido com: Execution Plan, Verification Checks, QA Guidance for Luna, Rollback.
- `mc-spawn.sh` recebe novos flags: `--plan`, `--checks`, `--qa`, `--rollback`.
- **Auto-inject de lessons**: script busca lessons.md do agente alvo, faz matching por domÃ­nio + pattern keywords (score â‰¥3), e injeta como "Known Pitfalls" na task spec.
- Matching refinado: domÃ­nio dÃ¡ peso 3, keywords do pattern dÃ£o peso 1. Threshold â‰¥3 elimina falsos positivos.
- AGENTS.md do Luan atualizado: Step 1 agora exige seguir Execution Plan em ordem, rodar Verification Checks, e mapear cada Acceptance Criteria.
- Completion Report do Luan expandido: seÃ§Ãµes "Acceptance Criteria Status" e "Verification Checks Output" obrigatÃ³rias.
- AGENTS.md da Luna atualizado: QA Review Protocol obrigatÃ³rio â€” ler lessons.md, cruzar com mudanÃ§as, verificar QA Guidance, criteria e checks.
- Template documentado em `docs/mc-task-spec-template.md` (v2).

## Crypto-Sage â€” Polymarket CTF Tracking Fixed (03:30 UTC)
- Crypto-sage nÃ£o contava posiÃ§Ãµes CTF (ERC-1155) do Polymarket. Reportava $178 ao invÃ©s de ~$400.
- Root cause: `POLYMARKET_POSITIONS_JSON` env var nunca adicionada ao systemd drop-in.
- Fix: scan on-chain encontrou 4 posiÃ§Ãµes: Iran Regime Jun30 (224 YES, 219 NO) + Iran Hormuz Mar31 (0.72 YES, 4.98 NO).
- Env var adicionada ao `crypto-sage-env.conf` + `.bashrc`. Total Polymarket: $229.42.
- Portfolio real: ~$401 (nÃ£o $178). DiferenÃ§a era toda em CTF shares nÃ£o contadas.
- Token desconhecido descoberto via event scan: `50005952...` (NO do Hormuz).

## PMM prod-002 Post-Mortem
- prod-002 morreu por capital exhaustion: $25 esgotou nos primeiros fills, depois 7390 rejections "not enough balance" por 20h.
- Complement routing funcionava (3766 rotas) mas dobra uso de capital (BUY em ambos os lados).
- 0 orders accepted no total (counter bug? ou todos aceitos viraram fills imediatamente?). 2 fills reais confirmados.
- Dados arquivados em `paper/data/archive-prod-002/`.

## PMM como ServiÃ§o Persistente no MC
- Card criado: `PMM Service: Polymarket Market Maker` (ID: `5fb3bb4e-159d-4b95-949c-c84b319a3554`)
- Status `in_progress` permanente â€” tipo SERVICE, nunca completa.
- Cron `pmm-status-updater.sh` (system crontab, cada 15min): parseia logs, atualiza card, auto-recovery se crashar.
- Heartbeat V3 atualizado: ignora tasks com tÃ­tulo "PMM Service:" no count de in_progress (nÃ£o bloqueia inbox drain).
- API endpoint correto para PATCH: `/api/v1/boards/{board_id}/tasks/{task_id}` (nÃ£o `/api/v1/tasks/{id}` â€” dÃ¡ 404).

## PMM P5 â€” Balance-Aware Quoting (Luan entregou)
- Luan implementou: Gate 5 (balance check antes de quotes), Step 9 (BID suppression), Step 10 (position recycling).
- 4 config params novos: `balance_aware_quoting`, `min_balance_to_quote`, `position_recycling`, `recycle_profit_threshold`.
- 676 testes passando, 13 novos. Lesson 11 adicionada (balance exhaustion pattern).
- Config `p5-001.yaml` criada mas PMM ainda nÃ£o relanÃ§ado (aguardando startup reconciliation).

## PMM Startup Reconciliation â€” Task Criada (nÃ£o spawnada)
- MC task: `64cad2ab-80f0-4f9c-a159-e89b339ecbab` â€” inbox, assigned to Luan.
- **SPAWN BLOQUEADO**: Matheus quer modificar workspace do Luan antes de disparar.
- 5 phases: cancel stale orders â†’ position sync on-chain â†’ market refresh â†’ safety checks â†’ integration.
- 11 acceptance criteria, QA guidance, verification checks. Risk profile: HIGH.
- Spec completa em `/tmp/pmm-reconciliation-task.md`.

## Gateway Restarts (3x nesta sessÃ£o)
1. ~00:28 UTC: `--force` para carregar dispatcher agent. Executou com sucesso.
2. ~01:57 UTC: `--force` para carregar dispatcher + recovery drop-in.
3. ~03:27 UTC: `--force` para carregar POLYMARKET_POSITIONS_JSON env var.
- Todos via `gateway-safe-restart.sh`. State snapshot + Discord notification funcionaram.
- Post-restart recovery (`99-post-restart-recovery.conf`) ativo â€” detectou PMM morto mas recovery falhou (P5 ainda nÃ£o pronto).

## MC API Token
- Token: `luna_mission_control_access_token_stable_v1_6741ef7ffc207adb58ce632e7ff1d9913dbf2e9c44441aac`
- NÃ£o estÃ¡ no env do gateway (precisa estar no .bashrc ou sourced pelos scripts).
- Scripts devem hardcodar ou ler do config â€” nÃ£o depender de env var do gateway.

## Matheus â€” Dashboards
- Matheus nÃ£o consegue acompanhar MC dashboard (142.93.87.36:3000) nem PMM dashboard.
- MC frontend roda OK (HTTP 200), problema pode ser de acesso/rede do lado dele.
- PMM nÃ£o tem dashboard dedicado â€” dados sÃ³ em logs. Pendente criar visualizaÃ§Ã£o.

## Crypto-Sage Supabase + Visual Upgrade Task (04:05 UTC)
- MC task criada: `830f458e-5874-4e8c-9e30-22d3f15dd819` â€” inbox, assigned Luan.
- **SPAWN BLOQUEADO**: mesma regra da task de reconciliation.
- Parte A: 4 tabelas Supabase (portfolio_snapshots, operations, positions, pnl_daily). Graceful degradation obrigatÃ³ria.
- Parte B: Discord visual upgrade â€” agrupamento por chain, % alocaÃ§Ã£o, PnL por posiÃ§Ã£o com ðŸ“ˆ/ðŸ“‰, delta 24h/7d.
- Novos comandos: `/saldo detalhado`, `/pnl`, `/historico`.
- Ãšnica dependÃªncia nova: `@supabase/supabase-js`.
- Risk: MEDIUM.

## MC Inbox Status (04:48 UTC)
- 2 tasks inbox aguardando autorizaÃ§Ã£o do Matheus:
  1. `64cad2ab` â€” PMM Startup Reconciliation (HIGH risk)
  2. `830f458e` â€” Crypto-Sage Supabase + Visual (MEDIUM risk)
- Matheus quer modificar workspace do Luan antes de spawnar qualquer uma.

---

## Resumo das Ãºltimas 24h (02-Mar 08:00 UTC â€” consolidado)

- **Mega-sessÃ£o produtiva (~18h de atividade contÃ­nua):** PerÃ­odo mais denso desde o inÃ­cio da operaÃ§Ã£o. Matheus presente e direcionando ativamente.
- **PMM prod-002 lanÃ§ado e encerrado:** Primeiro run com complement routing (SELL YES â†’ BUY NO). Geoblock resolvido via monkey-patch de proxy Tor. 4 orders aceitas, 2 fills. Morreu por capital exhaustion ($25 esgotou). Dados arquivados. P5 (balance-aware quoting) entregue pelo Luan â€” aguardando startup reconciliation.
- **Infra de autonomia expandida massivamente:** Dispatcher agent (gemini-flash, ~$0.001/dispatch vs $0.30 Opus), gateway safe-restart script (7 fases, rate-limited), post-restart recovery system (state snapshot + auto-resume via systemd drop-in), `mc-spawn.sh` com task specs estruturadas v2 (QA, lessons injection, plans).
- **Two-Phase Spawn Protocol implementado:** Luan entregou suporte a `PHASE: planning` / `PHASE: implementation` em `mc-spawn.sh`, `mc-spawn-luan.sh` e AGENTS.md de ambos. ObrigatÃ³rio para MEDIUM+ risk.
- **Gateway memory crisis resolvida:** 741MB â†’ 400MB apÃ³s limpeza de 267 sessÃµes de cron mortas (294â†’27). Python script ad-hoc + restart.
- **Crypto-sage Polymarket CTF tracking fixado:** PosiÃ§Ãµes ERC-1155 nÃ£o eram contadas. Env var `POLYMARKET_POSITIONS_JSON` adicionada. Portfolio real: ~$401 (vs $178 reportado antes).
- **PMM como serviÃ§o persistente no MC:** Card permanente (nunca completa), cron `pmm-status-updater.sh` cada 15min, heartbeat V3 ignora no count de in_progress.
- **2 tasks em inbox aguardando Matheus:** PMM Startup Reconciliation (HIGH) e Crypto-Sage Supabase + Visual (MEDIUM). Ambas bloqueadas â€” Matheus quer revisar workspace do Luan antes.
- **Whisper transcription broken:** Timeouts ao carregar modelo. Provavelmente memory pressure. NÃ£o resolvido.
- **Healthcheck matinal OK (08:00 UTC):** OpenClaw 2026.2.22-2, browser 0.9.1, Gmail token vÃ¡lido. Gateway saudÃ¡vel, 590MB.
- **Riscos:** (1) PMM parado â€” sem revenue e sem validaÃ§Ã£o atÃ© reconciliation. (2) Whisper broken = Ã¡udios do Matheus nÃ£o transcritos. (3) Doc debt crescendo (8+ itens carryover).

## Itens para organizar em Skills/Tools/Workflows

1. **Tools** â€” `gateway-safe-restart.sh` (7-phase safe restart, rate-limited, Discord notify): operacional mas nÃ£o em TOOLS.md. â†’ `TOOLS.md` seÃ§Ã£o "Gateway Safe Restart Script" *(novo)*
2. **Tools** â€” Post-restart recovery system (`gateway-state-snapshot.sh` + `gateway-post-restart-recovery.sh` + systemd drop-in `99-post-restart-recovery.conf`): crÃ­tico para operaÃ§Ã£o e nÃ£o documentado. â†’ `TOOLS.md` seÃ§Ã£o "Post-Restart Recovery" *(novo)*
3. **Tools** â€” Dispatcher agent (`workspace-dispatcher/`, gemini-flash, `mc-fast-dispatch.sh`): ativo mas sem doc. â†’ `TOOLS.md` seÃ§Ã£o "Dispatcher Agent" *(novo)*
4. **Workflows/Rotinas** â€” Two-Phase Spawn Protocol: implementado em scripts e AGENTS.md mas sem doc operacional standalone. â†’ `docs/operations/two-phase-spawn-guide.md` *(novo)*
5. **Workflows/Rotinas** â€” PMM paper trading iteration cycle (detectâ†’analyzeâ†’fixâ†’re-run): workflow maduro mas nÃ£o formalizado. â†’ `docs/operations/pmm-paper-trading-workflow.md` *(carryover 4 dias)*
6. **Tools** â€” MC lifecycle scripts (`mc-spawn.sh` v2 com specs estruturadas, `mc-complete.sh`, `mc-fail.sh`, `mc-spawn-luan.sh`): em AGENTS.md mas ausentes de TOOLS.md. â†’ `TOOLS.md` seÃ§Ã£o "MC Automation Scripts" *(carryover 4 dias)*
7. **Docs/Processo** â€” Gateway crash post-mortem 26/fev: precisa doc permanente. â†’ `docs/post-mortems/2026-02-26-gateway-crash.md` *(carryover 5 dias)*
8. **Docs/Processo** â€” `active-tasks.md` rewrite: arquivo reflete estado de 16/fev, severamente desatualizado (3.5+ semanas). â†’ `memory/active-tasks.md` *(urgÃªncia crÃ­tica)*
9. **Tools** â€” Tor SOCKS5 proxy para Polymarket + monkey-patch em `production_runner.py`: dependÃªncia operacional nÃ£o documentada. â†’ `TOOLS.md` seÃ§Ã£o "Tor Proxy (Polymarket)" *(carryover 2 dias)*
10. **Tools** â€” Sentinel scripts (`gateway-health-sentinel.sh`, `session-compact-sentinel.sh`): commitados mas nÃ£o documentados. â†’ `TOOLS.md` seÃ§Ã£o "Sentinel Scripts" *(carryover 2 dias)*
11. **Tools** â€” `pmm-status-updater.sh` (cron 15min, MC card auto-update + crash recovery): novo, operacional, nÃ£o documentado. â†’ `TOOLS.md` seÃ§Ã£o "PMM Status Updater" *(novo)*
12. **Docs/Processo** â€” CTO AgÃªntico runbook (`cto-ops-runbook.md`, `cto-risk-policy.json`): criado mas nÃ£o referenciado em TOOLS.md ou index. â†’ `TOOLS.md` seÃ§Ã£o "CTO-Ops Automation" *(novo)*

## Matheus â€” Diretrizes de Planejamento
- Quer tasks no MC com planos completos ANTES de spawnar agentes.
- Flag explÃ­cita de "spawn bloqueado" quando ele quer revisar/modificar antes.
- Prefere tasks com: problem statement detalhado, execution plan faseado, acceptance criteria objetivos, QA guidance, rollback plan.
- PMM deve ser tratado como serviÃ§o persistente no MC (nunca completa, priority crÃ­tica, auto-recovery).

## Post-Restart Wake (05:32 UTC)
- **Gateway healthy**: PID 2392303/2392316, 35min uptime, 590MB memory (well under 900MB watermark).
- **Version**: Sentinel reported update to 2026.2.25 but `openclaw --version` and `package.json` both show `2026.2.22-2`. Likely sentinel detection error â€” no actual version change.
- **No orphan MC tasks** â€” clean state post-restart.
- **No active subagents**.
- **PMM not running** â€” expected (prod-002 dead from capital exhaustion, startup reconciliation task blocked by Matheus).
- **2 MC tasks in inbox** waiting on Matheus: PMM Reconciliation (HIGH) and Crypto-Sage Supabase (MEDIUM).
- **Discord slow listener events** in logs (30s-164s timeouts) â€” boot-up transient, monitoring.
- **heartbeat-state.json missing** â€” will be recreated by next heartbeat cycle.
- Active sessions: heartbeat, discord#general-luna, crypto-sage, 4 cron jobs (watchdog, resource-monitor, delivery, this wake-up).
