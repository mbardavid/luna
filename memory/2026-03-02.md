# 2026-03-02 Session Log

## PMM prod-002 Launched
- Killed prod-001 (archived data to `archive-prod-001/`). prod-001 had 98.6% rejections (all SELLs).
- **Complement routing implemented by Luan** ‚Äî 655 tests, 14 new. SELL YES ‚Üí BUY NO when no position held.
- **Geoblock fix**: `py_clob_client` uses global `httpx.Client` without proxy. Monkey-patched in `production_runner.py` to use `socks5://127.0.0.1:9050` via `socksio`. Env var `POLYMARKET_PROXY` overrides.
- **prod-002 LIVE** on market "Will the Iranian regime fall by June 30?" (mid=0.475, vol=$1.1M, liq=$600K). First 4 orders all accepted, 2 instant fills. Zero rejections.
- Config: spread 30bps, requoting 3s, gamma 0.5, max position 50 shares/side, $25 capital, 24h duration.
- PID: stored in `paper/data/production_trading.pid`, logs in `logs/prod-002.log`.

## Crypto-Sage Portfolio ‚Äî Polymarket Integration Done
- Luan integrated `collectPolymarketPositions()` into `portfolio.mjs`. Fixed broken `import { getBalanceSummary }` ‚Üí `import { HyperliquidConnector }`.
- `--polymarket` flag for focused Polymarket view. `scripts/update-polymarket-env.sh` for systemd env var generation.
- Env vars (`POLYMARKET_POSITIONS_JSON`, `POLYMARKET_REALIZED_PNL`) still need to be added to systemd drop-in.

## Gateway Memory Crisis & Cleanup
- Gateway at **741MB / 900MB** (82% of high watermark). All CLI commands timing out.
- Root cause: **294 sessions in `sessions.json`** ‚Äî 282 were accumulated cron run sessions never cleaned.
- Fix: Python script pruned 267 dead cron runs (294 ‚Üí 27 sessions). File went from 2.7MB ‚Üí 217KB.
- Also cleaned ~35MB of `.deleted` and `.corrupt` transcript files across all agents.
- Post-restart: gateway dropped to **400MB** (~340MB freed).

## CTO Ag√™ntico ‚Äî Gateway Restart Authority
- **`scripts/gateway-safe-restart.sh`** created ‚Äî 7-phase safe restart protocol:
  1. Rate limit (max 3/hour) 2. Memory check (>70% watermark) 3. Session cleanup 4. Dry run gate 5. Discord notification 6. State snapshot 7. Restart
- **`cto-risk-policy.json`** updated: gateway restart moved from denylist to "high" risk with conditions.
- **`mc-resource-monitor.sh`** now auto-triggers restart when gateway memory >80% of cgroup watermark.
- **`cto-ops-runbook.md`** updated with gateway restart procedure.
- TOOLS.md updated: restart via script is now allowed (was previously "NUNCA").
- Matheus explicitly authorized this change.

## Post-Restart Recovery System
- **`scripts/gateway-state-snapshot.sh`** ‚Äî captures running state before restart (PMM processes, MC tasks, subagent sessions, PID files).
- **`scripts/gateway-post-restart-recovery.sh`** ‚Äî resumes work after restart (re-launches PMM, moves orphaned MC tasks to inbox, cleans stale sessions, notifies Discord).
- **systemd drop-in `99-post-restart-recovery.conf`** ‚Äî replaced `99-disable-startup-hook.conf`. ExecStartPost now runs recovery script.

## A2A Dispatch ‚Äî Architecture Analysis
- **Confirmed: `sessions.spawn` RPC does NOT exist** in OpenClaw gateway. Only available as AI tool call.
- Available RPC methods: `sessions.list`, `sessions.delete`, `cron.list`, `cron.run`, `health`, `status`, `system-presence`.
- **`openclaw agent`** CLI works for sending messages to agents from bash (~15-25K tokens per call, uses agent's full context).
- **`scripts/mc-fast-dispatch.sh`** created ‚Äî dispatches tasks directly via `openclaw agent` instead of slow queue+nudge.
- **heartbeat-v3.py updated** ‚Äî Phase 9 now tries fast-dispatch first, falls back to queue+nudge.

## A2A Dispatch ‚Äî Open Design Decision
- Matheus identified key gap: MC task descriptions are not self-sufficient for automated dispatch.
- Tasks need: detailed description, acceptance criteria, workspace paths, agent assignment.
- Currently Luna composes detailed task specs at spawn time, not at MC card creation time.
- **Dispatcher agent concept**: lightweight gemini-flash agent that receives "spawn X with task Y" and calls `sessions_spawn`. Reduces dispatch cost from 25K tokens (Opus) to 3K (Flash).
- **Blocker**: tasks need to be written as complete specs at creation time, not enriched later. This is not yet implemented.
- Options discussed: A) Luna writes full specs at creation, B) Smart dispatcher enriches, C) Keep current flow but automate detection‚Üínotification.

## Tor/Geoblock Solution (shared with Matheus's friend)
- Polymarket geoblocks US servers. Solution: Tor SOCKS5 proxy on port 9050.
- `/etc/tor/torrc`: `ExitNodes {jp},{br},{kr},{nl},{cw}` + `StrictNodes 1`.
- Works for API/CLOB. Website has additional Cloudflare protections ‚Äî VPN better for web UI.
- Latency ~900ms (acceptable for MM, not HFT).

## Whisper Transcription Issues
- `local-whisper-transcribe` and direct `faster_whisper` both timeout (SIGTERM) when loading model.
- Multiple attempts failed. Likely memory pressure related (gateway was at 741MB during attempts).
- Need to investigate: may need to run transcription when gateway memory is lower, or use a lighter model.

## Operational Notes
- MC API token not loaded in gateway env after restart ‚Äî needs to be in systemd drop-in or `.bashrc` sourced by scripts.
- MC board appears empty after restart (0 tasks) ‚Äî may be auth issue or data was cleaned.
- Heartbeat V3 operational: 10min interval, 7 phases, circuit breaker, queue escalation.
- 13 cron jobs running stable across CTO-ops infrastructure.

## Dispatcher Agent Implemented
- **Agente `dispatcher`** criado com gemini-flash, workspace m√≠nimo em `workspace-dispatcher/`.
- √önico prop√≥sito: receber "DISPATCH agent=X" + task spec, chamar `sessions_spawn`.
- Custo: ~3K tokens Flash (~$0.001) vs 25K Opus ($0.30) por dispatch.
- Adicionado ao `openclaw.json` com `allowAgents: [luan, crypto-sage, quant-strategist]`.
- `mc-fast-dispatch.sh` atualizado pra rotear via dispatcher ao inv√©s de direto pro agente alvo.
- **Gateway restart necess√°rio** pra carregar o novo agente.

## mc-spawn.sh ‚Äî Structured Task Specs
- Adicionadas flags estruturadas: `--objective`, `--context`, `--workspace`, `--files`, `--criteria`, `--constraints`, `--task-file`.
- Script auto-monta description formatada com template (Objective/Context/Workspace/Criteria/Constraints).
- Backward compat mantida: `--task` direto continua funcionando.
- Template documentado em `docs/mc-task-spec-template.md`.

## Decis√£o Matheus: Op√ß√£o A para dispatch
- Luna escreve specs completas no momento da cria√ß√£o do card MC (n√£o no dispatch).
- Dispatcher (flash) repassa sem enriquecer.
- Luan nasce com seu workspace completo (SOUL, MEMORY, LESSONS) independente de quem spawna.

## Post-Restart Recovery System
- `scripts/gateway-state-snapshot.sh` ‚Äî snapshot antes do restart (PMM, MC tasks, subagents).
- `scripts/gateway-post-restart-recovery.sh` ‚Äî recovery autom√°tico (re-lan√ßa PMM, MC tasks √≥rf√£s ‚Üí inbox).
- systemd drop-in `99-post-restart-recovery.conf` habilitado (substituiu `99-disable-startup-hook.conf`).

## MC Task Spec v2 ‚Äî Plano + QA + Lessons
- Template expandido com: Execution Plan, Verification Checks, QA Guidance for Luna, Rollback.
- `mc-spawn.sh` recebe novos flags: `--plan`, `--checks`, `--qa`, `--rollback`.
- **Auto-inject de lessons**: script busca lessons.md do agente alvo, faz matching por dom√≠nio + pattern keywords (score ‚â•3), e injeta como "Known Pitfalls" na task spec.
- Matching refinado: dom√≠nio d√° peso 3, keywords do pattern d√£o peso 1. Threshold ‚â•3 elimina falsos positivos.
- AGENTS.md do Luan atualizado: Step 1 agora exige seguir Execution Plan em ordem, rodar Verification Checks, e mapear cada Acceptance Criteria.
- Completion Report do Luan expandido: se√ß√µes "Acceptance Criteria Status" e "Verification Checks Output" obrigat√≥rias.
- AGENTS.md da Luna atualizado: QA Review Protocol obrigat√≥rio ‚Äî ler lessons.md, cruzar com mudan√ßas, verificar QA Guidance, criteria e checks.
- Template documentado em `docs/mc-task-spec-template.md` (v2).

## Crypto-Sage ‚Äî Polymarket CTF Tracking Fixed (03:30 UTC)
- Crypto-sage n√£o contava posi√ß√µes CTF (ERC-1155) do Polymarket. Reportava $178 ao inv√©s de ~$400.
- Root cause: `POLYMARKET_POSITIONS_JSON` env var nunca adicionada ao systemd drop-in.
- Fix: scan on-chain encontrou 4 posi√ß√µes: Iran Regime Jun30 (224 YES, 219 NO) + Iran Hormuz Mar31 (0.72 YES, 4.98 NO).
- Env var adicionada ao `crypto-sage-env.conf` + `.bashrc`. Total Polymarket: $229.42.
- Portfolio real: ~$401 (n√£o $178). Diferen√ßa era toda em CTF shares n√£o contadas.
- Token desconhecido descoberto via event scan: `50005952...` (NO do Hormuz).

## PMM prod-002 Post-Mortem
- prod-002 morreu por capital exhaustion: $25 esgotou nos primeiros fills, depois 7390 rejections "not enough balance" por 20h.
- Complement routing funcionava (3766 rotas) mas dobra uso de capital (BUY em ambos os lados).
- 0 orders accepted no total (counter bug? ou todos aceitos viraram fills imediatamente?). 2 fills reais confirmados.
- Dados arquivados em `paper/data/archive-prod-002/`.

## PMM como Servi√ßo Persistente no MC
- Card criado: `PMM Service: Polymarket Market Maker` (ID: `5fb3bb4e-159d-4b95-949c-c84b319a3554`)
- Status `in_progress` permanente ‚Äî tipo SERVICE, nunca completa.
- Cron `pmm-status-updater.sh` (system crontab, cada 15min): parseia logs, atualiza card, auto-recovery se crashar.
- Heartbeat V3 atualizado: ignora tasks com t√≠tulo "PMM Service:" no count de in_progress (n√£o bloqueia inbox drain).
- API endpoint correto para PATCH: `/api/v1/boards/{board_id}/tasks/{task_id}` (n√£o `/api/v1/tasks/{id}` ‚Äî d√° 404).

## PMM P5 ‚Äî Balance-Aware Quoting (Luan entregou)
- Luan implementou: Gate 5 (balance check antes de quotes), Step 9 (BID suppression), Step 10 (position recycling).
- 4 config params novos: `balance_aware_quoting`, `min_balance_to_quote`, `position_recycling`, `recycle_profit_threshold`.
- 676 testes passando, 13 novos. Lesson 11 adicionada (balance exhaustion pattern).
- Config `p5-001.yaml` criada mas PMM ainda n√£o relan√ßado (aguardando startup reconciliation).

## PMM Startup Reconciliation ‚Äî Task Criada (n√£o spawnada)
- MC task: `64cad2ab-80f0-4f9c-a159-e89b339ecbab` ‚Äî inbox, assigned to Luan.
- **SPAWN BLOQUEADO**: Matheus quer modificar workspace do Luan antes de disparar.
- 5 phases: cancel stale orders ‚Üí position sync on-chain ‚Üí market refresh ‚Üí safety checks ‚Üí integration.
- 11 acceptance criteria, QA guidance, verification checks. Risk profile: HIGH.
- Spec completa em `/tmp/pmm-reconciliation-task.md`.

## Gateway Restarts (3x nesta sess√£o)
1. ~00:28 UTC: `--force` para carregar dispatcher agent. Executou com sucesso.
2. ~01:57 UTC: `--force` para carregar dispatcher + recovery drop-in.
3. ~03:27 UTC: `--force` para carregar POLYMARKET_POSITIONS_JSON env var.
- Todos via `gateway-safe-restart.sh`. State snapshot + Discord notification funcionaram.
- Post-restart recovery (`99-post-restart-recovery.conf`) ativo ‚Äî detectou PMM morto mas recovery falhou (P5 ainda n√£o pronto).

## MC API Token
- Token: `luna_mission_control_access_token_stable_v1_6741ef7ffc207adb58ce632e7ff1d9913dbf2e9c44441aac`
- N√£o est√° no env do gateway (precisa estar no .bashrc ou sourced pelos scripts).
- Scripts devem hardcodar ou ler do config ‚Äî n√£o depender de env var do gateway.

## Matheus ‚Äî Dashboards
- Matheus n√£o consegue acompanhar MC dashboard (142.93.87.36:3000) nem PMM dashboard.
- MC frontend roda OK (HTTP 200), problema pode ser de acesso/rede do lado dele.
- PMM n√£o tem dashboard dedicado ‚Äî dados s√≥ em logs. Pendente criar visualiza√ß√£o.

## Crypto-Sage Supabase + Visual Upgrade Task (04:05 UTC)
- MC task criada: `830f458e-5874-4e8c-9e30-22d3f15dd819` ‚Äî inbox, assigned Luan.
- **SPAWN BLOQUEADO**: mesma regra da task de reconciliation.
- Parte A: 4 tabelas Supabase (portfolio_snapshots, operations, positions, pnl_daily). Graceful degradation obrigat√≥ria.
- Parte B: Discord visual upgrade ‚Äî agrupamento por chain, % aloca√ß√£o, PnL por posi√ß√£o com üìà/üìâ, delta 24h/7d.
- Novos comandos: `/saldo detalhado`, `/pnl`, `/historico`.
- √önica depend√™ncia nova: `@supabase/supabase-js`.
- Risk: MEDIUM.

## MC Inbox Status (04:48 UTC)
- 2 tasks inbox aguardando autoriza√ß√£o do Matheus:
  1. `64cad2ab` ‚Äî PMM Startup Reconciliation (HIGH risk)
  2. `830f458e` ‚Äî Crypto-Sage Supabase + Visual (MEDIUM risk)
- Matheus quer modificar workspace do Luan antes de spawnar qualquer uma.

## Matheus ‚Äî Diretrizes de Planejamento
- Quer tasks no MC com planos completos ANTES de spawnar agentes.
- Flag expl√≠cita de "spawn bloqueado" quando ele quer revisar/modificar antes.
- Prefere tasks com: problem statement detalhado, execution plan faseado, acceptance criteria objetivos, QA guidance, rollback plan.
- PMM deve ser tratado como servi√ßo persistente no MC (nunca completa, priority cr√≠tica, auto-recovery).

## Post-Restart Wake (05:32 UTC)
- **Gateway healthy**: PID 2392303/2392316, 35min uptime, 590MB memory (well under 900MB watermark).
- **Version**: Sentinel reported update to 2026.2.25 but `openclaw --version` and `package.json` both show `2026.2.22-2`. Likely sentinel detection error ‚Äî no actual version change.
- **No orphan MC tasks** ‚Äî clean state post-restart.
- **No active subagents**.
- **PMM not running** ‚Äî expected (prod-002 dead from capital exhaustion, startup reconciliation task blocked by Matheus).
- **2 MC tasks in inbox** waiting on Matheus: PMM Reconciliation (HIGH) and Crypto-Sage Supabase (MEDIUM).
- **Discord slow listener events** in logs (30s-164s timeouts) ‚Äî boot-up transient, monitoring.
- **heartbeat-state.json missing** ‚Äî will be recreated by next heartbeat cycle.
- Active sessions: heartbeat, discord#general-luna, crypto-sage, 4 cron jobs (watchdog, resource-monitor, delivery, this wake-up).
