# 2026-03-02 Session Log

## PMM prod-002 Launched
- Killed prod-001 (archived data to `archive-prod-001/`). prod-001 had 98.6% rejections (all SELLs).
- **Complement routing implemented by Luan** — 655 tests, 14 new. SELL YES → BUY NO when no position held.
- **Geoblock fix**: `py_clob_client` uses global `httpx.Client` without proxy. Monkey-patched in `production_runner.py` to use `socks5://127.0.0.1:9050` via `socksio`. Env var `POLYMARKET_PROXY` overrides.
- **prod-002 LIVE** on market "Will the Iranian regime fall by June 30?" (mid=0.475, vol=$1.1M, liq=$600K). First 4 orders all accepted, 2 instant fills. Zero rejections.
- Config: spread 30bps, requoting 3s, gamma 0.5, max position 50 shares/side, $25 capital, 24h duration.
- PID: stored in `paper/data/production_trading.pid`, logs in `logs/prod-002.log`.

## Crypto-Sage Portfolio — Polymarket Integration Done
- Luan integrated `collectPolymarketPositions()` into `portfolio.mjs`. Fixed broken `import { getBalanceSummary }` → `import { HyperliquidConnector }`.
- `--polymarket` flag for focused Polymarket view. `scripts/update-polymarket-env.sh` for systemd env var generation.
- Env vars (`POLYMARKET_POSITIONS_JSON`, `POLYMARKET_REALIZED_PNL`) still need to be added to systemd drop-in.

## Gateway Memory Crisis & Cleanup
- Gateway at **741MB / 900MB** (82% of high watermark). All CLI commands timing out.
- Root cause: **294 sessions in `sessions.json`** — 282 were accumulated cron run sessions never cleaned.
- Fix: Python script pruned 267 dead cron runs (294 → 27 sessions). File went from 2.7MB → 217KB.
- Also cleaned ~35MB of `.deleted` and `.corrupt` transcript files across all agents.
- Post-restart: gateway dropped to **400MB** (~340MB freed).

## CTO Agêntico — Gateway Restart Authority
- **`scripts/gateway-safe-restart.sh`** created — 7-phase safe restart protocol:
  1. Rate limit (max 3/hour) 2. Memory check (>70% watermark) 3. Session cleanup 4. Dry run gate 5. Discord notification 6. State snapshot 7. Restart
- **`cto-risk-policy.json`** updated: gateway restart moved from denylist to "high" risk with conditions.
- **`mc-resource-monitor.sh`** now auto-triggers restart when gateway memory >80% of cgroup watermark.
- **`cto-ops-runbook.md`** updated with gateway restart procedure.
- TOOLS.md updated: restart via script is now allowed (was previously "NUNCA").
- Matheus explicitly authorized this change.

## Post-Restart Recovery System
- **`scripts/gateway-state-snapshot.sh`** — captures running state before restart (PMM processes, MC tasks, subagent sessions, PID files).
- **`scripts/gateway-post-restart-recovery.sh`** — resumes work after restart (re-launches PMM, moves orphaned MC tasks to inbox, cleans stale sessions, notifies Discord).
- **systemd drop-in `99-post-restart-recovery.conf`** — replaced `99-disable-startup-hook.conf`. ExecStartPost now runs recovery script.

## A2A Dispatch — Architecture Analysis
- **Confirmed: `sessions.spawn` RPC does NOT exist** in OpenClaw gateway. Only available as AI tool call.
- Available RPC methods: `sessions.list`, `sessions.delete`, `cron.list`, `cron.run`, `health`, `status`, `system-presence`.
- **`openclaw agent`** CLI works for sending messages to agents from bash (~15-25K tokens per call, uses agent's full context).
- **`scripts/mc-fast-dispatch.sh`** created — dispatches tasks directly via `openclaw agent` instead of slow queue+nudge.
- **heartbeat-v3.py updated** — Phase 9 now tries fast-dispatch first, falls back to queue+nudge.

## A2A Dispatch — Open Design Decision
- Matheus identified key gap: MC task descriptions are not self-sufficient for automated dispatch.
- Tasks need: detailed description, acceptance criteria, workspace paths, agent assignment.
- Currently Luna composes detailed task specs at spawn time, not at MC card creation time.
- **Dispatcher agent concept**: lightweight gemini-flash agent that receives "spawn X with task Y" and calls `sessions_spawn`. Reduces dispatch cost from 25K tokens (Opus) to 3K (Flash).
- **Blocker**: tasks need to be written as complete specs at creation time, not enriched later. This is not yet implemented.
- Options discussed: A) Luna writes full specs at creation, B) Smart dispatcher enriches, C) Keep current flow but automate detection→notification.

## Tor/Geoblock Solution (shared with Matheus's friend)
- Polymarket geoblocks US servers. Solution: Tor SOCKS5 proxy on port 9050.
- `/etc/tor/torrc`: `ExitNodes {jp},{br},{kr},{nl},{cw}` + `StrictNodes 1`.
- Works for API/CLOB. Website has additional Cloudflare protections — VPN better for web UI.
- Latency ~900ms (acceptable for MM, not HFT).

## Whisper Transcription Issues
- `local-whisper-transcribe` and direct `faster_whisper` both timeout (SIGTERM) when loading model.
- Multiple attempts failed. Likely memory pressure related (gateway was at 741MB during attempts).
- Need to investigate: may need to run transcription when gateway memory is lower, or use a lighter model.

## Operational Notes
- MC API token not loaded in gateway env after restart — needs to be in systemd drop-in or `.bashrc` sourced by scripts.
- MC board appears empty after restart (0 tasks) — may be auth issue or data was cleaned.
- Heartbeat V3 operational: 10min interval, 7 phases, circuit breaker, queue escalation.
- 13 cron jobs running stable across CTO-ops infrastructure.

## Dispatcher Agent Implemented
- **Agente `dispatcher`** criado com gemini-flash, workspace mínimo em `workspace-dispatcher/`.
- Único propósito: receber "DISPATCH agent=X" + task spec, chamar `sessions_spawn`.
- Custo: ~3K tokens Flash (~$0.001) vs 25K Opus ($0.30) por dispatch.
- Adicionado ao `openclaw.json` com `allowAgents: [luan, crypto-sage, quant-strategist]`.
- `mc-fast-dispatch.sh` atualizado pra rotear via dispatcher ao invés de direto pro agente alvo.
- **Gateway restart necessário** pra carregar o novo agente.

## mc-spawn.sh — Structured Task Specs
- Adicionadas flags estruturadas: `--objective`, `--context`, `--workspace`, `--files`, `--criteria`, `--constraints`, `--task-file`.
- Script auto-monta description formatada com template (Objective/Context/Workspace/Criteria/Constraints).
- Backward compat mantida: `--task` direto continua funcionando.
- Template documentado em `docs/mc-task-spec-template.md`.

## Decisão Matheus: Opção A para dispatch
- Luna escreve specs completas no momento da criação do card MC (não no dispatch).
- Dispatcher (flash) repassa sem enriquecer.
- Luan nasce com seu workspace completo (SOUL, MEMORY, LESSONS) independente de quem spawna.

## Post-Restart Recovery System
- `scripts/gateway-state-snapshot.sh` — snapshot antes do restart (PMM, MC tasks, subagents).
- `scripts/gateway-post-restart-recovery.sh` — recovery automático (re-lança PMM, MC tasks órfãs → inbox).
- systemd drop-in `99-post-restart-recovery.conf` habilitado (substituiu `99-disable-startup-hook.conf`).

## MC Task Spec v2 — Plano + QA + Lessons
- Template expandido com: Execution Plan, Verification Checks, QA Guidance for Luna, Rollback.
- `mc-spawn.sh` recebe novos flags: `--plan`, `--checks`, `--qa`, `--rollback`.
- **Auto-inject de lessons**: script busca lessons.md do agente alvo, faz matching por domínio + pattern keywords (score ≥3), e injeta como "Known Pitfalls" na task spec.
- Matching refinado: domínio dá peso 3, keywords do pattern dão peso 1. Threshold ≥3 elimina falsos positivos.
- AGENTS.md do Luan atualizado: Step 1 agora exige seguir Execution Plan em ordem, rodar Verification Checks, e mapear cada Acceptance Criteria.
- Completion Report do Luan expandido: seções "Acceptance Criteria Status" e "Verification Checks Output" obrigatórias.
- AGENTS.md da Luna atualizado: QA Review Protocol obrigatório — ler lessons.md, cruzar com mudanças, verificar QA Guidance, criteria e checks.
- Template documentado em `docs/mc-task-spec-template.md` (v2).
