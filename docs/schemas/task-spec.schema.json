{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://openclaw.local/schemas/task-spec.schema.json",
  "title": "InternalA2ATaskSpec",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "taskSpecVersion",
    "handoffId",
    "correlationId",
    "createdAt",
    "source",
    "target",
    "routing",
    "mode",
    "intent",
    "acceptance",
    "safety",
    "rollback",
    "audit"
  ],
  "properties": {
    "taskSpecVersion": {
      "type": "string",
      "enum": [
        "1.0",
        "1.1"
      ]
    },
    "handoffId": {
      "type": "string",
      "pattern": "^hs_[A-Za-z0-9._:-]{8,128}$"
    },
    "correlationId": {
      "type": "string",
      "minLength": 6,
      "maxLength": 128
    },
    "parentHandoffId": {
      "type": "string",
      "pattern": "^hs_[A-Za-z0-9._:-]{8,128}$"
    },
    "createdAt": {
      "type": "string",
      "format": "date-time"
    },
    "source": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "agentId",
        "sessionId"
      ],
      "properties": {
        "agentId": {
          "type": "string",
          "minLength": 2,
          "maxLength": 64
        },
        "sessionId": {
          "type": "string",
          "minLength": 3,
          "maxLength": 256
        }
      }
    },
    "target": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "agentId",
        "capability"
      ],
      "properties": {
        "agentId": {
          "type": "string",
          "minLength": 2,
          "maxLength": 64
        },
        "capability": {
          "type": "string",
          "minLength": 3,
          "maxLength": 128
        }
      }
    },
    "routing": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "strategy",
        "routeKey"
      ],
      "properties": {
        "strategy": {
          "type": "string",
          "enum": [
            "direct",
            "capability"
          ]
        },
        "routeKey": {
          "type": "string",
          "minLength": 6,
          "maxLength": 160
        },
        "fallbackAgentId": {
          "type": "string",
          "minLength": 2,
          "maxLength": 64
        }
      }
    },
    "mode": {
      "type": "string",
      "enum": [
        "dev",
        "simulated",
        "live"
      ]
    },
    "authorship": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "mode"
      ],
      "properties": {
        "mode": {
          "type": "string",
          "enum": [
            "direct",
            "delegated-human-proxy"
          ]
        },
        "delegationPolicy": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "policyRef",
            "allowAgents",
            "allowChannels",
            "allowTasks"
          ],
          "properties": {
            "policyRef": {
              "type": "string",
              "minLength": 6,
              "maxLength": 260
            },
            "allowAgents": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "string",
                "minLength": 2,
                "maxLength": 64
              }
            },
            "allowChannels": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "string",
                "minLength": 2,
                "maxLength": 128
              }
            },
            "allowTasks": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "string",
                "minLength": 2,
                "maxLength": 128
              }
            }
          }
        },
        "envelope": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "principal",
            "delegateAgent",
            "scope",
            "ttl",
            "proof"
          ],
          "properties": {
            "principal": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "id"
              ],
              "properties": {
                "id": {
                  "type": "string",
                  "minLength": 2,
                  "maxLength": 128
                },
                "type": {
                  "type": "string",
                  "enum": [
                    "human",
                    "service-account"
                  ]
                }
              }
            },
            "delegateAgent": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "agentId"
              ],
              "properties": {
                "agentId": {
                  "type": "string",
                  "minLength": 2,
                  "maxLength": 64
                },
                "sessionId": {
                  "type": "string",
                  "minLength": 3,
                  "maxLength": 256
                }
              }
            },
            "scope": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "agents",
                "channels",
                "tasks"
              ],
              "properties": {
                "agents": {
                  "type": "array",
                  "minItems": 1,
                  "items": {
                    "type": "string",
                    "minLength": 2,
                    "maxLength": 64
                  }
                },
                "channels": {
                  "type": "array",
                  "minItems": 1,
                  "items": {
                    "type": "string",
                    "minLength": 2,
                    "maxLength": 128
                  }
                },
                "tasks": {
                  "type": "array",
                  "minItems": 1,
                  "items": {
                    "type": "string",
                    "minLength": 2,
                    "maxLength": 128
                  }
                }
              }
            },
            "ttl": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "issuedAt",
                "expiresAt"
              ],
              "properties": {
                "issuedAt": {
                  "type": "string",
                  "format": "date-time"
                },
                "expiresAt": {
                  "type": "string",
                  "format": "date-time"
                }
              }
            },
            "proof": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "algorithm",
                "signature",
                "hash"
              ],
              "properties": {
                "algorithm": {
                  "type": "string",
                  "minLength": 3,
                  "maxLength": 64
                },
                "signature": {
                  "type": "string",
                  "minLength": 8,
                  "maxLength": 1024
                },
                "hash": {
                  "type": "string",
                  "minLength": 8,
                  "maxLength": 256
                }
              }
            }
          }
        },
        "risk": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "classification",
            "requiresConfirmation"
          ],
          "properties": {
            "classification": {
              "type": "string",
              "enum": [
                "read",
                "diagnostic",
                "sensitive",
                "live"
              ]
            },
            "requiresConfirmation": {
              "type": "boolean"
            },
            "authorizationRef": {
              "type": [
                "string",
                "null"
              ],
              "minLength": 3,
              "maxLength": 180
            }
          }
        },
        "mentionDelegationMode": {
          "type": "string",
          "enum": [
            "disabled",
            "gated"
          ]
        },
        "mentionDelegation": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "channel",
            "messageId",
            "originBotId",
            "targetBotId",
            "observedAt",
            "ttlSeconds",
            "dedupeBy"
          ],
          "properties": {
            "channel": {
              "type": "string",
              "pattern": "^discord:(channel|thread):[0-9]{6,30}$"
            },
            "messageId": {
              "type": "string",
              "pattern": "^[0-9]{6,30}$"
            },
            "originBotId": {
              "type": "string",
              "minLength": 2,
              "maxLength": 128
            },
            "targetBotId": {
              "type": "string",
              "minLength": 2,
              "maxLength": 128
            },
            "observedAt": {
              "type": "string",
              "format": "date-time"
            },
            "ttlSeconds": {
              "type": "integer",
              "minimum": 5,
              "maximum": 3600
            },
            "dedupeBy": {
              "const": "messageId"
            }
          }
        }
      }
    },
    "loop_id": {
      "type": "string",
      "description": "Unique identifier for the review loop cycle",
      "pattern": "^loop_[a-z0-9]{8,64}$"
    },
    "proposed_by": {
      "type": "string",
      "description": "Agent that originated the proposal",
      "minLength": 2,
      "maxLength": 64
    },
    "risk_profile": {
      "type": "string",
      "description": "Risk classification for the task",
      "enum": [
        "low",
        "medium",
        "high",
        "critical"
      ]
    },
    "review_depth": {
      "type": "integer",
      "description": "Maximum number of review cycles before escalation",
      "minimum": 1,
      "maximum": 10
    },
    "review_feedback_required": {
      "type": "boolean",
      "description": "Whether explicit review feedback is required before execution"
    },
    "auto_approve_window": {
      "type": "integer",
      "description": "Seconds within which low-risk tasks can be auto-approved",
      "minimum": 0,
      "maximum": 86400
    },
    "review_reason": {
      "type": "string",
      "description": "Reason provided during critique/rejection phase",
      "maxLength": 1000
    },
    "intent": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "operation",
        "inputSchemaRef",
        "input"
      ],
      "properties": {
        "operation": {
          "type": "string",
          "minLength": 3,
          "maxLength": 128
        },
        "summary": {
          "type": "string",
          "maxLength": 500
        },
        "inputSchemaRef": {
          "type": "string",
          "minLength": 8,
          "maxLength": 300
        },
        "input": {
          "type": "object"
        }
      }
    },
    "acceptance": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "doneWhen"
      ],
      "properties": {
        "doneWhen": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 3,
            "maxLength": 280
          }
        },
        "expectedArtifacts": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 2,
            "maxLength": 180
          }
        }
      }
    },
    "safety": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "e2eActor",
        "allowExternalSideEffects",
        "requiresHumanApproval"
      ],
      "properties": {
        "e2eActor": {
          "type": "string",
          "enum": [
            "human",
            "authorized-harness"
          ]
        },
        "allowExternalSideEffects": {
          "type": "boolean"
        },
        "requiresHumanApproval": {
          "type": "boolean"
        }
      }
    },
    "rollback": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "required",
        "planRef"
      ],
      "properties": {
        "required": {
          "const": true
        },
        "planRef": {
          "type": "string",
          "minLength": 6,
          "maxLength": 260
        },
        "trigger": {
          "type": "string",
          "maxLength": 300
        }
      }
    },
    "audit": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "requestId",
        "idempotencyKey"
      ],
      "properties": {
        "requestId": {
          "type": "string",
          "minLength": 4,
          "maxLength": 128
        },
        "idempotencyKey": {
          "type": "string",
          "minLength": 6,
          "maxLength": 160
        },
        "traceId": {
          "type": "string",
          "maxLength": 180
        },
        "delegation": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "policyRef",
            "envelopeHash",
            "riskClassification",
            "authorizationRef",
            "decision",
            "validatedAt",
            "recordedBy"
          ],
          "properties": {
            "policyRef": {
              "type": "string",
              "minLength": 6,
              "maxLength": 260
            },
            "envelopeHash": {
              "type": "string",
              "minLength": 8,
              "maxLength": 256
            },
            "riskClassification": {
              "type": "string",
              "enum": [
                "read",
                "diagnostic",
                "sensitive",
                "live"
              ]
            },
            "authorizationRef": {
              "type": [
                "string",
                "null"
              ],
              "minLength": 3,
              "maxLength": 180
            },
            "decision": {
              "type": "string",
              "enum": [
                "allowed",
                "denied",
                "expired",
                "revoked"
              ]
            },
            "validatedAt": {
              "type": "string",
              "format": "date-time"
            },
            "recordedBy": {
              "type": "string",
              "minLength": 2,
              "maxLength": 128
            }
          }
        }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "mode": {
            "const": "live"
          }
        }
      },
      "then": {
        "properties": {
          "safety": {
            "properties": {
              "requiresHumanApproval": {
                "const": true
              },
              "allowExternalSideEffects": {
                "const": true
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "required": [
          "authorship"
        ],
        "properties": {
          "authorship": {
            "required": [
              "mode"
            ],
            "properties": {
              "mode": {
                "const": "delegated-human-proxy"
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "authorship": {
            "required": [
              "delegationPolicy",
              "envelope",
              "risk"
            ]
          },
          "audit": {
            "required": [
              "delegation"
            ]
          }
        }
      }
    },
    {
      "if": {
        "required": [
          "authorship"
        ],
        "properties": {
          "authorship": {
            "required": [
              "mentionDelegationMode"
            ],
            "properties": {
              "mentionDelegationMode": {
                "const": "gated"
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "authorship": {
            "required": [
              "mode",
              "mentionDelegation"
            ],
            "properties": {
              "mode": {
                "const": "delegated-human-proxy"
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "required": [
          "authorship"
        ],
        "properties": {
          "authorship": {
            "required": [
              "mentionDelegation"
            ]
          }
        }
      },
      "then": {
        "properties": {
          "authorship": {
            "required": [
              "mentionDelegationMode"
            ],
            "properties": {
              "mentionDelegationMode": {
                "const": "gated"
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "required": [
          "authorship"
        ],
        "properties": {
          "authorship": {
            "required": [
              "mode",
              "risk"
            ],
            "properties": {
              "mode": {
                "const": "delegated-human-proxy"
              },
              "risk": {
                "required": [
                  "classification"
                ],
                "properties": {
                  "classification": {
                    "enum": [
                      "read",
                      "diagnostic"
                    ]
                  }
                }
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "authorship": {
            "properties": {
              "risk": {
                "required": [
                  "requiresConfirmation"
                ],
                "properties": {
                  "requiresConfirmation": {
                    "const": false
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "required": [
          "authorship"
        ],
        "properties": {
          "authorship": {
            "required": [
              "mode",
              "risk"
            ],
            "properties": {
              "mode": {
                "const": "delegated-human-proxy"
              },
              "risk": {
                "required": [
                  "classification"
                ],
                "properties": {
                  "classification": {
                    "enum": [
                      "sensitive",
                      "live"
                    ]
                  }
                }
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "authorship": {
            "properties": {
              "risk": {
                "required": [
                  "requiresConfirmation",
                  "authorizationRef"
                ],
                "properties": {
                  "requiresConfirmation": {
                    "const": true
                  },
                  "authorizationRef": {
                    "type": "string",
                    "minLength": 3,
                    "maxLength": 180
                  }
                }
              }
            }
          },
          "audit": {
            "properties": {
              "delegation": {
                "required": [
                  "authorizationRef"
                ],
                "properties": {
                  "authorizationRef": {
                    "type": "string",
                    "minLength": 3,
                    "maxLength": 180
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "taskSpecVersion": {
            "const": "1.1"
          }
        }
      },
      "then": {
        "required": [
          "proposed_by",
          "loop_id",
          "risk_profile",
          "review_depth",
          "review_feedback_required",
          "auto_approve_window"
        ]
      }
    }
  ]
}
